<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kairis</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icons/icon-192x192.png">
    <!-- Chosen Palette: Warm Neutrals (Slate & Sky) - Dark Mode -->
    <!-- Application Structure Plan: A mobile-first SPA with a fixed bottom tab bar for primary navigation between "Watchlist" and "Scanner". The "Detail" view is now a separate, full-screen view that appears on top of the current view, with a dedicated back button, which is a standard mobile UI pattern. The watchlist itself is now sub-tabbed for "TW" and "US" markets. This architecture prioritizes mobile ergonomics, one-handed operation, and clear information separation. -->
    <!-- Visualization & Content Choices: 
        - [Stock List]: Goal: Inform/Compare. Method: A single-column list of cards. Now includes key indicators (High, Low, MAs) with a conditional star 'â˜…' to indicate when price is below a MA. Interaction: Click to navigate to detail view. Justification: The star provides an immediate visual cue for potential weakness.
        - [Detail Page Tabs]: Goal: Organize. Method: A new sub-tab navigation for Analysis, Chart, and News. Justification: Organizes a growing amount of information on the detail page into logical sections, preventing cognitive overload.
        - [Advanced Chart]: Goal: Analyze Change. Method: Upgraded to a Chart.js Candlestick chart using a financial plugin, showing 30-day OHLC data. Now includes Daily/Weekly timeframe switching. Interaction: Hover/touch for tooltips with full OHLC info, click to switch timeframe. Justification: Fulfills user request for a more professional K-line chart with multiple timeframes.
        - [News Feed]: Goal: Inform. Method: A list of mock news articles. Justification: Adds a qualitative, event-driven context to the quantitative data.
        - [7-Day Price Visual]: Goal: Analyze Change/Compare. Method: Custom HTML/CSS visualization. Displays the full high-low range as text. Interaction: Static display. Justification: Implements user's visual preference.
        - [Scanner]: Goal: Organize/Discover. Method: Single-column list of cards. Now tabbed by market (TW/US). Layout adjusted to prioritize price info over the reason. Interaction: Click to navigate to detail view. Justification: Aligns with user workflow of seeing price first and filtering by market.
        - [Add Stock]: Goal: Input. Method: Text input now intelligently appends market suffix based on the active tab. Interaction: User types symbol and clicks add. Justification: A significant usability improvement.
        - [Theme]: The app is now set to a permanent dark theme.
        - [Last Updated]: Goal: Inform. Method: A simple text element on each main view. Interaction: Static. Justification: Provides crucial context on data freshness.
        - [Gemini Analysis]: Goal: Synthesize/Explain. Method: Button-triggered text block. Interaction: Click to generate analysis.
        - Library/Method: Vanilla JS for all logic, Gemini API for AI analysis, Chart.js with chartjs-chart-financial plugin for advanced chart.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script>
        // æ‰‹å‹•è¨»å†Š financial chart æ§åˆ¶å™¨
        window.addEventListener('load', function() {
            if (window.Chart && window.Chart.controllers && window.Chart.controllers.CandlestickController) {
                console.log('Financial chart controllers are available');
            } else {
                console.warn('Financial chart controllers not found');
            }
        });
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }
        .app-container {
            max-width: 440px; /* Mobile first */
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding-bottom: 64px; /* Space for bottom nav */
        }
        
        /* Tablet styles (iPad) */
        @media (min-width: 768px) and (max-width: 1023.98px) {
            .app-container {
                max-width: 100%;
                padding-bottom: 64px; /* Keep space for bottom nav */
                box-shadow: none;
            }
            
            .header-desktop {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                max-width: 100% !important;
                z-index: 10;
            }
            
            .main-desktop {
                padding-top: 5rem !important; /* Space for fixed header */
                max-height: calc(100vh - 140px);
            }
            
            .bottom-nav-desktop {
                display: flex !important; /* Show bottom nav on iPad */
                max-width: 100% !important;
            }
            
            .sidebar-desktop {
                display: none; /* Hide sidebar on iPad */
            }
            
            /* Two-column grid for cards on iPad */
            #stock-list-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
            
            #buy-opportunities,
            #sell-opportunities {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
        }
        
        /* Desktop styles */
        @media (min-width: 1024px) {
            .app-container {
                max-width: 100%;
                display: grid;
                grid-template-columns: 280px 1fr;
                grid-template-rows: 1fr;
                grid-template-areas: 
                    "sidebar main";
                padding-bottom: 0;
                height: 100vh;
                box-shadow: none;
            }
            
            .header-desktop {
                display: none; /* Hide header on desktop */
            }
            
            .main-desktop {
                grid-area: main;
                padding: 1rem !important;
                border-left: 1px solid #374151;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .sidebar-desktop {
                grid-area: sidebar;
                background-color: #1e293b;
                border-right: 1px solid #374151;
                display: flex;
                flex-direction: column;
                padding: 1rem;
            }
            
            .bottom-nav-desktop {
                display: none;
            }
            
            .nav-item-desktop {
                padding: 0.75rem 1rem;
                margin-bottom: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background-color 0.2s;
                color: #94a3b8;
                font-weight: 600;
            }
            
            .nav-item-desktop:hover {
                background-color: #374151;
            }
            
            .nav-item-desktop.active {
                background-color: #0ea5e9;
                color: white;
            }
            
            /* Two-column grid for cards on desktop */
            .stock-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .opportunity-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            /* Detail view adjustments for desktop */
            #view-detail {
                position: fixed !important;
                inset: 0 !important;
                transform: none !important;
                z-index: 30 !important;
            }
        }
        main {
            transition: transform 0.3s ease;
        }
        #pull-to-refresh-indicator {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        .strength-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 5px solid #475569; /* slate-600 */
            border-bottom-color: #0ea5e9; /* sky-500 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .price-range-bar-bg {
            height: 20px;
            border-radius: 4px;
            position: relative;
        }
        .price-range-bar-fg {
            height: 100%;
            position: absolute;
        }
        .price-range-bar-tick {
            width: 2px;
            height: 100%;
            position: absolute;
        }
        .ma-star {
            color: #f59e0b; /* amber-500 */
            font-weight: bold;
        }
        .advanced-chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-black text-slate-200 font-sans transition-colors duration-300">

    <div id="app" class="app-container bg-slate-900 flex flex-col h-screen">
        
        <!-- Desktop Sidebar (hidden on mobile) -->
        <aside class="sidebar-desktop hidden lg:flex">
            <h1 class="text-xl font-bold text-white mb-6">Kairis</h1>
            <nav class="flex-1">
                <div class="nav-item-desktop active" data-view="watchlist">
                    <span class="text-sm font-semibold">è‡ªé¸åˆ—è¡¨</span>
                </div>
                <div class="nav-item-desktop" data-view="scanner">
                    <span class="text-sm font-semibold">æ©Ÿæœƒæƒæ</span>
                </div>
                
                <!-- Market selection for desktop -->
                <div id="desktop-market-controls" class="mt-6 mb-4">
                    <div class="mb-3">
                        <div class="flex bg-slate-700 rounded-lg p-1">
                            <button data-market="US" class="desktop-market-tab flex-1 px-3 py-2 text-sm font-semibold rounded-md text-slate-300">ç¾è‚¡</button>
                            <button data-market="TW" class="desktop-market-tab flex-1 px-3 py-2 text-sm font-semibold rounded-md text-slate-300">å°è‚¡</button>
                        </div>
                    </div>
                    <button id="desktop-add-stock-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                        + æ–°å¢è‚¡ç¥¨
                    </button>
                </div>
            </nav>
            <div id="sidebar-auth-section" class="mt-auto pt-4 border-t border-slate-700">
                <!-- Auth content will be injected here -->
            </div>
        </aside>
        
        <header id="main-header" class="fixed top-0 left-0 right-0 max-w-md mx-auto bg-slate-800 flex-shrink-0 z-10 p-4 border-b border-slate-700 md:max-w-full lg:hidden header-desktop">
             <!-- Header content is injected by JS -->
        </header>

        <main class="p-4 pt-20 relative flex-grow overflow-y-auto lg:pt-4 main-desktop">
             <div id="pull-to-refresh-indicator">
                <div class="loader !w-6 !h-6 !border-4"></div>
            </div>
            <!-- Watchlist View -->
            <div id="view-watchlist" class="view">
                <p id="watchlist-last-updated" class="text-xs text-slate-500 text-right mb-2"></p>
                <div id="stock-list-container" class="space-y-3">
                    <!-- Stock cards will be injected here -->
                </div>
            </div>

            <!-- Scanner View -->
            <div id="view-scanner" class="view hidden">
                <p id="scanner-last-updated" class="text-xs text-slate-500 text-right mb-2"></p>
                <p class="text-sm text-slate-400">æœ¬é é¢æœƒè‡ªå‹•æƒææ‚¨è‡ªé¸åˆ—è¡¨ä¸­çš„æ‰€æœ‰è‚¡ç¥¨ï¼Œä¸¦æ ¹æ“šé è¨­çš„æŠ€è¡“æŒ‡æ¨™ï¼Œç¯©é¸å‡ºç¬¦åˆç‰¹å®šæ¢ä»¶çš„æ½›åœ¨è²·è³£æ©Ÿæœƒã€‚</p>
                <div class="space-y-6 mt-4">
                    <div>
                        <h3 class="text-lg font-semibold text-green-500 mb-2">æ½›åœ¨è²·é€²æ©Ÿæœƒ</h3>
                        <div id="buy-opportunities" class="space-y-3">
                            <!-- Buy opportunity cards will be injected here -->
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-red-500 mb-2">æ½›åœ¨è³£å‡ºæ©Ÿæœƒ</h3>
                        <div id="sell-opportunities" class="space-y-3">
                            <!-- Sell opportunity cards will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail View - Now acts as a full-page overlay -->
    <div id="view-detail" class="fixed inset-0 bg-slate-900 z-20 hidden transform translate-x-full transition-transform duration-300 app-container">
        <header class="bg-slate-800 sticky top-0 z-10 p-4 border-b border-slate-700 flex items-center">
            <button id="back-btn" class="text-sky-500 text-2xl mr-4 w-8 h-8 flex items-center justify-center active:bg-slate-700 rounded-full">â€¹</button>
            <h2 id="detail-header-title" class="text-lg font-bold truncate">å€‹è‚¡è©³æƒ…</h2>
        </header>
        <div id="detail-content-wrapper" class="overflow-y-auto h-[calc(100vh-65px)]">
             <div id="detail-content" class="p-4">
                <!-- Detail content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (hidden on desktop) -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-800 border-t border-slate-700 flex justify-around h-16 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] md:max-w-full lg:hidden bottom-nav-desktop">
        <button data-view="watchlist" class="bottom-nav-tab flex flex-col items-center justify-center text-sky-500 w-full active:bg-slate-700 transition-colors">
            <span class="text-sm font-semibold">è‡ªé¸åˆ—è¡¨</span>
        </button>
        <button data-view="scanner" class="bottom-nav-tab flex flex-col items-center justify-center text-slate-400 w-full active:bg-slate-700 transition-colors">
            <span class="text-sm font-semibold">æ©Ÿæœƒæƒæ</span>
        </button>
    </nav>

    <!-- Add Stock Modal -->
    <div id="add-stock-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">æ–°å¢è‚¡ç¥¨</h3>
            <p id="add-stock-prompt" class="text-slate-400 mb-2"></p>
            <input type="text" id="add-stock-input" class="w-full border border-slate-600 rounded-md p-2 bg-slate-700" placeholder="è¼¸å…¥ä»£è™Ÿ...">
            <p id="add-stock-feedback" class="text-xs text-red-500 mt-1 h-4"></p>
            <div class="flex gap-2 mt-4">
                 <button id="modal-add-btn" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">æ–°å¢</button>
                 <button id="close-modal-btn" class="flex-1 bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Confirm Remove Modal -->
    <div id="confirm-remove-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">ç¢ºèªåˆªé™¤</h3>
            <p id="remove-stock-prompt" class="text-slate-300 mb-6"></p>
            <div class="flex gap-2">
                 <button id="confirm-remove-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ç¢ºå®š</button>
                 <button id="cancel-remove-btn" class="flex-1 bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


<script>
// *** START: Firebase Integration ***
const firebaseConfig = {
apiKey: "AIzaSyCbny5Pe0tbUI91H6Fd39mC-lhxcQDvOkk",
authDomain: "kairis-2ff35.firebaseapp.com",
projectId: "kairis-2ff35",
storageBucket: "kairis-2ff35.firebasestorage.app",
messagingSenderId: "720426426161",
appId: "1:720426426161:web:9c85abf4eacfc84be5da10",
measurementId: "G-75W5RT06MP"
};
// *** END: Firebase Integration ***

// è¨»å†Š Chart.js é‡‘èæ’ä»¶
document.addEventListener('DOMContentLoaded', () => {
    // ç¢ºä¿é‡‘èåœ–è¡¨æ’ä»¶æ­£ç¢ºè¼‰å…¥
    if (typeof Chart !== 'undefined' && Chart.controllers && Chart.controllers.CandlestickController) {
        Chart.register(Chart.controllers.CandlestickController, Chart.elements.CandlestickElement);
        console.log('Candlestick controller registered successfully');
    } else {
        console.warn('Candlestick controller not found, will use fallback');
    }
});

const App = {
    state: {
        currentView: 'watchlist',
        watchlistMarketView: 'US',
        scannerMarketView: 'US',
        watchlist: [], 
        selectedStock: null,
        stockToRemove: null,
        detailViewTab: 'analysis',
        chartTimeframe: 'D',
        previousView: 'watchlist',
        isGeminiLoading: false,
        lastUpdated: null,
        advancedChartInstance: null,
        macdChartInstance: null,
        stockDataCache: {},
        newsCache: {},
        isLoading: false,
        db: null,
        auth: null,
        userId: null,
        user: null,
        watchlistUnsubscribe: null,
    },

    async init() {
        this.setupEventListeners();
        this.setupPullToRefresh();
        this.updateTime();
        await this.initFirebase();
        setInterval(() => {
            this.updateTime();
            if(this.state.currentView !== 'detail') {
                this.fetchAllWatchlistData(true);
            }
        }, 60000);
    },

    async initFirebase() {
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn("Firebase æœªè¨­å®šï¼Œè‡ªé¸è‚¡æ¸…å–®å°‡å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ä¸­ã€‚");
            this.loadWatchlistFromLocalStorage();
            return;
        }

        try {
            firebase.initializeApp(firebaseConfig);
            this.state.db = firebase.firestore();
            this.state.auth = firebase.auth();

            this.state.auth.onAuthStateChanged(user => {
                this.state.user = user;
                if (user) {
                    this.state.userId = user.uid;
                    console.log("ç”¨æˆ¶å·²ç™»å…¥:", user.uid);
                    this.loadWatchlistFromFirestore();
                } else {
                    console.log("é–‹å§‹åŒ¿åç™»å…¥...");
                    this.state.auth.signInAnonymously()
                        .then(() => {
                            console.log("åŒ¿åç™»å…¥æˆåŠŸ");
                        })
                        .catch(error => {
                            console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                            this.loadWatchlistFromLocalStorage();
                        });
                }
                this.renderHeader();
            });
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            this.loadWatchlistFromLocalStorage();
        }
    },

    loadWatchlistFromFirestore() {
        if (this.state.watchlistUnsubscribe) {
            this.state.watchlistUnsubscribe();
        }
        if (!this.state.db || !this.state.userId) {
            console.log("Firebase æˆ–ç”¨æˆ¶ ID æœªæº–å‚™å¥½ï¼Œä½¿ç”¨æœ¬åœ°å­˜å„²");
            this.loadWatchlistFromLocalStorage();
            return;
        }

        console.log("å¾ Firestore è¼‰å…¥ watchlistï¼Œç”¨æˆ¶ ID:", this.state.userId);
        const docRef = this.state.db.collection('users').doc(this.state.userId);
        
        this.state.watchlistUnsubscribe = docRef.onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                let watchlistData = Array.isArray(data.watchlist) ? data.watchlist : [];
                // éæ¿¾æ‰å°è‚¡ï¼Œåªä¿ç•™ç¾è‚¡
                this.state.watchlist = watchlistData.filter(symbol => !symbol.includes('.TW'));
            } else {
                this.state.watchlist = ['AAPL.US'];
                docRef.set({ watchlist: this.state.watchlist });
            }
            this.fetchAllWatchlistData();
        }, error => {
            console.error("è®€å– watchlist å¤±æ•—:", error);
        });
    },
    
    loadWatchlistFromLocalStorage() {
        const saved = localStorage.getItem('stockwise_watchlist');
        let savedWatchlist = saved ? JSON.parse(saved) : ['AAPL.US'];
        // éæ¿¾æ‰å°è‚¡ï¼Œåªä¿ç•™ç¾è‚¡
        this.state.watchlist = savedWatchlist.filter(symbol => !symbol.includes('.TW'));
        this.fetchAllWatchlistData();
    },

    saveWatchlistToLocalStorage() {
        localStorage.setItem('stockwise_watchlist', JSON.stringify(this.state.watchlist));
    },

    updateTime() {
        this.state.lastUpdated = new Date();
    },

    async fetchStockData(symbol, forceRefresh = false, timeframe = null) {
        const cacheKey = timeframe === '5M' ? `${symbol}_5M` : symbol;
        
        // ğŸš€ æª¢æŸ¥å¿«å–ï¼Œå¦‚æœæœ‰è³‡æ–™å°±ç«‹å³è¿”å› (æ¨‚è§€æ›´æ–°)
        if (this.state.stockDataCache[cacheKey] && !this.state.stockDataCache[cacheKey].error && !forceRefresh) {
            console.log(`Using cached data for ${symbol}${timeframe ? ` (${timeframe})` : ''}`);
            
            // èƒŒæ™¯æ›´æ–°ï¼šå¦‚æœè³‡æ–™è¶…é2åˆ†é˜ï¼Œåœ¨èƒŒæ™¯é‡æ–°è¼‰å…¥
            const cacheAge = Date.now() - (this.state.stockDataCache[cacheKey]._fetchTime || 0);
            if (cacheAge > 120000) { // 2åˆ†é˜
                console.log(`Background refresh for ${symbol}`);
                this.fetchStockData(symbol, true, timeframe).then(() => {
                    this.render(); // éœé»˜æ›´æ–° UI
                }).catch(console.error);
            }
            
            return this.state.stockDataCache[cacheKey];
        }
        
        // ğŸš€ é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ä½†ä¿ç•™èˆŠè³‡æ–™ (é¿å…é–ƒçˆ)
        const oldData = this.state.stockDataCache[cacheKey];
        this.state.stockDataCache[cacheKey] = { 
            ...oldData, 
            isLoading: true,
            _fetchTime: Date.now()
        };

        try {
            const url = timeframe ? `/api/get-stock-data?symbol=${symbol}&timeframe=${timeframe}` : `/api/get-stock-data?symbol=${symbol}`;
            console.log(`[${new Date().toISOString()}] Fetching data from API for ${symbol}${timeframe ? ` (${timeframe})` : ''}`);
            
            // ğŸš€ åŠ å…¥ fetch è¶…æ™‚æ©Ÿåˆ¶ - èª¿æ•´åˆ° 45 ç§’ (è‚¡ç¥¨APIè¼ƒæ…¢)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.warn(`â° ${symbol} API è«‹æ±‚è¶…é 45 ç§’ï¼Œä¸­æ­¢è«‹æ±‚`);
                controller.abort();
            }, 45000); // 45ç§’è¶…æ™‚
            
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'Cache-Control': 'no-cache'
                }
            });
            clearTimeout(timeoutId);
            
            const data = await response.json();

            if (!response.ok) {
                console.error(`API error for ${symbol}:`, data.error);
                const errorData = { error: data.error || 'ç²å–è³‡æ–™å¤±æ•—' };
                this.state.stockDataCache[cacheKey] = errorData;
                return errorData;
            }
            
            const market = symbol.endsWith('.TW') ? 'TW' : 'US';
            const currency = market === 'TW' ? 'NT$' : '$';
            const processedData = { ...data, name: data.name || symbol, market, currency, pe: data.pe || null };
            this.state.stockDataCache[cacheKey] = processedData;
            return processedData;

        } catch (error) {
            console.error(`âŒ ${symbol} è«‹æ±‚å¤±æ•—:`, error);
            let errorMessage = 'ç¶²è·¯è«‹æ±‚å¤±æ•—';
            
            // ğŸš€ æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†
            if (error.name === 'AbortError') {
                errorMessage = `${symbol} API å›æ‡‰éæ…¢ (>45ç§’)`;
                console.warn(`ğŸŒ ${symbol} è¼‰å…¥æ™‚é–“éé•·ï¼Œå·²è‡ªå‹•è·³é`);
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—';
            } else if (error.message.includes('timeout')) {
                errorMessage = 'è«‹æ±‚è¶…æ™‚';
            } else if (error.message.includes('500')) {
                errorMessage = 'ä¼ºæœå™¨æš«æ™‚ç„¡æ³•å›æ‡‰';
            }
            
            const errorData = { 
                error: errorMessage,
                symbol: symbol,
                timestamp: Date.now()
            };
            this.state.stockDataCache[cacheKey] = errorData;
            return errorData;
        }
    },

    async fetchAllWatchlistData(forceRefresh = false) {
        if (!forceRefresh) {
            this.state.isLoading = true;
            this.render();
        }

        // éæ¿¾æ‰å°è‚¡ï¼Œåªè™•ç†ç¾è‚¡
        const symbolsToFetch = this.state.watchlist
            .filter(symbol => !symbol.includes('.TW'))
            .filter(symbol => !this.state.stockDataCache[symbol] || forceRefresh);
        
        console.log(`ğŸš€ é–‹å§‹è¼‰å…¥ ${symbolsToFetch.length} å€‹è‚¡ç¥¨...`);
        
        // ğŸš€ å„ªåŒ–ï¼šæ‰¹æ¬¡è¼‰å…¥ + è¶…æ™‚æ©Ÿåˆ¶ + å³æ™‚æ›´æ–°
        const BATCH_SIZE = 3; // æ¯æ‰¹3å€‹
        const TIMEOUT_PER_STOCK = 50000; // æ¯è‚¡50ç§’è¶…æ™‚ (é…åˆ fetch 45ç§’)
        let completed = 0;
        
        // åˆ†æ‰¹è™•ç†
        for (let i = 0; i < symbolsToFetch.length; i += BATCH_SIZE) {
            const batch = symbolsToFetch.slice(i, i + BATCH_SIZE);
            console.log(`ğŸ“¦ è™•ç†æ‰¹æ¬¡ ${Math.floor(i/BATCH_SIZE) + 1}: ${batch.join(', ')}`);
            
            // ç‚ºæ¯å€‹ API åŠ ä¸Šè¶…æ™‚æ©Ÿåˆ¶
            const batchPromises = batch.map(symbol => 
                Promise.race([
                    this.fetchStockData(symbol, forceRefresh),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('timeout')), TIMEOUT_PER_STOCK)
                    )
                ]).catch(error => {
                    console.warn(`âš ï¸ ${symbol} è¼‰å…¥å¤±æ•—:`, error.message);
                    return { symbol, error: 'è¼‰å…¥è¶…æ™‚' };
                })
            );
            
            // ç­‰å¾…æ‰¹æ¬¡å®Œæˆ
            await Promise.allSettled(batchPromises);
            completed += batch.length;
            
            // å³æ™‚æ›´æ–° UI
            console.log(`âœ… å·²å®Œæˆ ${completed}/${symbolsToFetch.length} å€‹è‚¡ç¥¨`);
            this.render();
        }

        this.state.isLoading = false;
        this.render();
        console.log(`ğŸ‰ è‡ªé¸åˆ—è¡¨è¼‰å…¥å®Œæˆï¼`);
    },

    setupEventListeners() {
        // Mobile bottom navigation
        document.querySelectorAll('.bottom-nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view));
        });
        
        // Desktop sidebar navigation
        document.querySelectorAll('.nav-item-desktop').forEach(item => {
            item.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view));
        });
        
        // Desktop market tabs
        document.querySelectorAll('.desktop-market-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                if (this.state.currentView === 'watchlist') {
                    this.state.watchlistMarketView = e.currentTarget.dataset.market;
                } else if (this.state.currentView === 'scanner') {
                    this.state.scannerMarketView = e.currentTarget.dataset.market;
                }
                this.render();
            });
        });
        
        // Desktop add stock button
        const desktopAddBtn = document.getElementById('desktop-add-stock-btn');
        if (desktopAddBtn) {
            desktopAddBtn.addEventListener('click', () => this.toggleModal(true));
        }
        
        document.getElementById('back-btn').addEventListener('click', () => this.closeDetailView());
        document.getElementById('close-modal-btn').addEventListener('click', () => this.toggleModal(false));
        document.getElementById('modal-add-btn').addEventListener('click', () => this.addStockFromInput());
        document.getElementById('cancel-remove-btn').addEventListener('click', () => this.toggleRemoveModal(false));
        document.getElementById('confirm-remove-btn').addEventListener('click', () => this.confirmRemoveStock());
    },

    setupPullToRefresh() {
        const mainEl = document.querySelector('main');
        let startY = 0;
        let pullDistance = 0;
        const refreshThreshold = 80;

        mainEl.addEventListener('touchstart', (e) => {
            if (mainEl.scrollTop === 0 && this.state.currentView !== 'detail') {
                startY = e.touches[0].pageY;
            }
        }, { passive: true });

        mainEl.addEventListener('touchmove', (e) => {
            if (mainEl.scrollTop === 0 && startY > 0) {
                const currentY = e.touches[0].pageY;
                pullDistance = currentY - startY;
                if (pullDistance > 0) {
                    mainEl.style.transform = `translateY(${Math.min(pullDistance, refreshThreshold * 1.5)}px)`;
                }
            }
        }, { passive: true });

        mainEl.addEventListener('touchend', async () => {
            if (pullDistance > refreshThreshold) {
                mainEl.style.transform = `translateY(50px)`;
                await this.fetchAllWatchlistData(true);
                mainEl.style.transform = 'translateY(0px)';
            } else {
                mainEl.style.transform = 'translateY(0px)';
            }
            startY = 0;
            pullDistance = 0;
        });
    },

    navigate(view) {
        if (!view) return;
        this.state.currentView = view;
        this.render();
    },

    render() {
        this.renderHeader();
        
        document.querySelectorAll('#app > main > .view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${this.state.currentView}`).classList.remove('hidden');

        // Update mobile bottom navigation
        document.querySelectorAll('.bottom-nav-tab').forEach(tab => {
            tab.classList.remove('text-sky-500');
            tab.classList.add('text-slate-400');
        });
        const activeTab = document.querySelector(`.bottom-nav-tab[data-view="${this.state.currentView}"]`);
        if (activeTab) {
            activeTab.classList.add('text-sky-500');
            activeTab.classList.remove('text-slate-400');
        }

        // Update desktop sidebar navigation
        document.querySelectorAll('.nav-item-desktop').forEach(item => {
            item.classList.remove('active');
        });
        const activeDesktopItem = document.querySelector(`.nav-item-desktop[data-view="${this.state.currentView}"]`);
        if (activeDesktopItem) {
            activeDesktopItem.classList.add('active');
        }

        // Update desktop market tabs
        document.querySelectorAll('.desktop-market-tab').forEach(tab => {
            tab.classList.remove('bg-slate-800', 'shadow', 'text-white');
            tab.classList.add('text-slate-300');
        });
        
        const currentMarketView = this.state.currentView === 'watchlist' ? this.state.watchlistMarketView : this.state.scannerMarketView;
        document.querySelectorAll(`.desktop-market-tab[data-market="${currentMarketView}"]`).forEach(tab => {
            tab.classList.add('bg-slate-800', 'shadow', 'text-white');
            tab.classList.remove('text-slate-300');
        });

        if (this.state.currentView === 'watchlist') {
            this.renderWatchlist();
        } else if (this.state.currentView === 'scanner') {
            this.renderScanner();
        }
    },
    
    renderHeader() {
        const header = document.getElementById('main-header');
        const sidebarAuthSection = document.getElementById('sidebar-auth-section');
        let content = '';

        let authContent = '';
        if (this.state.user && !this.state.user.isAnonymous) {
            authContent = `
                <div class="flex items-center gap-2">
                    <img src="${this.state.user.photoURL}" alt="User" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="text-xs text-slate-400 hover:text-white">ç™»å‡º</button>
                </div>
            `;
        } else {
            authContent = `<button id="login-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg transition-colors text-sm">ä½¿ç”¨ Google ç™»å…¥</button>`;
        }

        // Update sidebar auth section for desktop
        if (sidebarAuthSection) {
            sidebarAuthSection.innerHTML = authContent;
        }

        if (this.state.currentView === 'watchlist') {
            content = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="flex bg-slate-700 rounded-lg p-1 h-9">
                            <button data-market="US" class="market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.watchlistMarketView === 'US' ? 'bg-slate-800 shadow' : ''}">ç¾è‚¡</button>
                            <button data-market="TW" class="market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.watchlistMarketView === 'TW' ? 'bg-slate-800 shadow' : ''}">å°è‚¡</button>
                        </div>
                        <button id="add-stock-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold h-9 w-9 flex items-center justify-center rounded-lg transition-colors text-lg">+</button>
                    </div>
                    <div class="lg:hidden">
                        ${authContent}
                    </div>
                </div>
            `;
        } else if (this.state.currentView === 'scanner') {
            content = `
                <div class="flex justify-between items-center">
                    <div class="flex bg-slate-700 rounded-lg p-1">
                        <button data-market="US" class="scanner-market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.scannerMarketView === 'US' ? 'bg-slate-800 shadow' : ''}">ç¾è‚¡</button>
                        <button data-market="TW" class="scanner-market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.scannerMarketView === 'TW' ? 'bg-slate-800 shadow' : ''}">å°è‚¡</button>
                    </div>
                    <div class="lg:hidden">
                        ${authContent}
                    </div>
                </div>
            `;
        }
        header.innerHTML = content;

        // Bind auth events for both header and sidebar
        const loginBtns = document.querySelectorAll('#login-btn');
        const logoutBtns = document.querySelectorAll('#logout-btn');
        
        loginBtns.forEach(btn => {
            btn.addEventListener('click', () => this.handleGoogleLogin());
        });
        
        logoutBtns.forEach(btn => {
            btn.addEventListener('click', () => this.handleLogout());
        });

        if (this.state.currentView === 'watchlist') {
            const addBtn = document.getElementById('add-stock-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.toggleModal(true));
            document.querySelectorAll('.market-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.watchlistMarketView = e.currentTarget.dataset.market;
                    this.render();
                });
            });
        } else if (this.state.currentView === 'scanner') {
            document.querySelectorAll('.scanner-market-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.scannerMarketView = e.currentTarget.dataset.market;
                    this.render();
                });
            });
        }
    },

    handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        this.state.auth.signInWithPopup(provider).catch(error => {
            console.error("Google ç™»å…¥å¤±æ•—:", error);
        });
    },

    handleLogout() {
        this.state.auth.signOut();
    },

    renderWatchlist() {
        document.getElementById('watchlist-last-updated').textContent = `æœ€å¾Œæ›´æ–°: ${this.state.lastUpdated.toLocaleTimeString('zh-TW')}`;
        const container = document.getElementById('stock-list-container');
        
        if (this.state.isLoading && this.state.watchlist.length > 0) {
            container.innerHTML = `<div class="loader mx-auto mt-10"></div>`;
            return;
        }

        container.innerHTML = '';
        const filteredList = this.state.watchlist
            .filter(symbol => {
                const market = symbol.endsWith('.TW') ? 'TW' : 'US';
                return market === this.state.watchlistMarketView;
            })
            .sort((a, b) => a.localeCompare(b));

        if (filteredList.length === 0) {
            container.innerHTML = `<p class="text-slate-400 text-center mt-10">æ­¤åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ã€æ–°å¢è‚¡ç¥¨ã€‚</p>`;
            return;
        }

        // Add responsive grid class for desktop
        container.className = 'space-y-3 md:space-y-0 lg:stock-grid';

        filteredList.forEach(symbol => {
            const stock = this.state.stockDataCache[symbol];
            if (!stock || stock.isLoading) {
                container.innerHTML += `<div class="bg-slate-800 p-4 rounded-xl shadow-sm h-[136px] flex items-center justify-center"><div class="loader"></div></div>`;
                return;
            }
            if (stock.error) {
                 container.innerHTML += `<div class="bg-slate-800 p-4 rounded-xl shadow-sm text-center text-red-500">${symbol}: ${stock.error}</div>`;
                return;
            }

            const indicators = this.calculateIndicators(stock);
            const isUS = stock.market === 'US';
            const isUp = stock.change >= 0;
            const colorClass = isUp ? (isUS ? 'text-green-500' : 'text-red-500') : (isUS ? 'text-red-500' : 'text-green-500');
            
            const card = `
                <div class="bg-slate-800 p-4 rounded-xl shadow-sm cursor-pointer active:bg-slate-700" data-symbol="${symbol}">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-base truncate">${symbol.replace(/\.US$|\.TW$/, '')}</p>
                            <p class="text-xs text-slate-400 truncate">${stock.name}</p>
                        </div>
                        <div class="text-right pl-2">
                            <p class="text-lg font-bold ${colorClass}">${stock.currency}${stock.price.toFixed(2)}</p>
                            <p class="text-sm ${colorClass}">${isUp ? 'â–²' : 'â–¼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                        </div>
                        <button class="remove-stock-btn text-slate-600 hover:text-red-500 text-2xl ml-3 w-8 h-8 flex items-center justify-center" data-symbol="${symbol}">Ã—</button>
                    </div>
                    <div class="text-xs text-slate-400 mt-3 pt-3 border-t border-slate-700">
                        <div class="flex justify-between">
                            <span>ä½: <span class="text-red-500">${stock.low.toFixed(2)}</span></span>
                            <span>é«˜: <span class="text-green-500">${stock.high.toFixed(2)}</span></span>
                        </div>
                        <div class="flex justify-between mt-1">
                            <span>3æ—¥ç·š: ${indicators.ma3.toFixed(2)}${stock.price < indicators.ma3 ? '<span class="ma-star"> â˜…</span>' : ''}</span>
                            <span>5æ—¥ç·š: ${indicators.ma5.toFixed(2)}${stock.price < indicators.ma5 ? '<span class="ma-star"> â˜…</span>' : ''}</span>
                            <span>10æ—¥ç·š: ${indicators.ma10.toFixed(2)}${stock.price < indicators.ma10 ? '<span class="ma-star"> â˜…</span>' : ''}</span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });

        document.querySelectorAll('#stock-list-container [data-symbol]').forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-stock-btn')) return;
                this.selectStock(card.dataset.symbol);
            });
        });
        document.querySelectorAll('.remove-stock-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.promptRemoveStock(btn.dataset.symbol);
            });
        });
    },

    renderScanner() {
        document.getElementById('scanner-last-updated').textContent = `æœ€å¾Œæ›´æ–°: ${this.state.lastUpdated.toLocaleTimeString('zh-TW')}`;
        const buyContainer = document.getElementById('buy-opportunities');
        const sellContainer = document.getElementById('sell-opportunities');
        
        if (this.state.isLoading) {
            buyContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            sellContainer.innerHTML = '';
            return;
        }

        let buyOpportunities = [];
        let sellOpportunities = [];
        
        const filteredList = this.state.watchlist.filter(symbol => {
            const stockData = this.state.stockDataCache[symbol];
            return stockData && !stockData.error && stockData.market === this.state.scannerMarketView;
        });

        filteredList.forEach(symbol => {
            const stock = this.state.stockDataCache[symbol];
            if (!stock || stock.isLoading || stock.error) return;

            const indicators = this.calculateIndicators(stock);
            const signals = this.getSignals(symbol, stock, indicators);

            if (signals.buy.reasons.length > 0) {
                buyOpportunities.push({ symbol, stock, signalData: signals.buy });
            }
            if (signals.sell.reasons.length > 0) {
                sellOpportunities.push({ symbol, stock, signalData: signals.sell });
            }
        });

        buyOpportunities.sort((a, b) => b.signalData.score - a.signalData.score);
        sellOpportunities.sort((a, b) => b.signalData.score - a.signalData.score);

        // Add responsive grid classes for desktop
        buyContainer.className = 'space-y-3 md:space-y-0 lg:opportunity-grid';
        sellContainer.className = 'space-y-3 md:space-y-0 lg:opportunity-grid';

        buyContainer.innerHTML = buyOpportunities.length > 0 ? buyOpportunities.map(op => this.createOpportunityCard(op.symbol, op.stock, op.signalData)).join('') : `<p class="text-slate-400 text-center p-4">æš«ç„¡ç¬¦åˆæ¢ä»¶çš„è²·é€²æ©Ÿæœƒã€‚</p>`;
        sellContainer.innerHTML = sellOpportunities.length > 0 ? sellOpportunities.map(op => this.createOpportunityCard(op.symbol, op.stock, op.signalData)).join('') : `<p class="text-slate-400 text-center p-4">æš«ç„¡ç¬¦åˆæ¢ä»¶çš„è³£å‡ºæ©Ÿæœƒã€‚</p>`;

        document.querySelectorAll('.opportunity-card').forEach(card => {
            card.addEventListener('click', () => this.selectStock(card.dataset.symbol));
        });
    },

    createOpportunityCard(symbol, stock, signalData) {
        const isUS = stock.market === 'US';
        const isUp = stock.change >= 0;
        const colorClass = isUp ? (isUS ? 'text-green-500' : 'text-red-500') : (isUS ? 'text-red-500' : 'text-green-500');
        
        let strengthHTML = '';
        for (let i = 0; i < 3; i++) {
            const color = i < signalData.score ? 'bg-yellow-400' : 'bg-slate-600';
            strengthHTML += `<span class="strength-dot ${color}"></span>`;
        }
        
        const reasonsHTML = signalData.reasons.map(reason => `<li class="text-xs">${reason}</li>`).join('');

        return `
            <div class="opportunity-card bg-slate-800 p-4 rounded-lg shadow-sm cursor-pointer active:bg-slate-700" data-symbol="${symbol}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-base truncate">${symbol.replace(/\.US$|\.TW$/, '')}</p>
                        <p class="text-xs text-slate-400 truncate">${stock.name}</p>
                    </div>
                    <div class="text-right flex-shrink-0 pl-2">
                        <p class="font-bold text-base ${colorClass}">${stock.currency}${stock.price.toFixed(2)}</p>
                        <p class="text-sm ${colorClass}">${isUp ? 'â–²' : 'â–¼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                    </div>
                </div>
                <div class="flex justify-between items-end text-sm mt-2 pt-2 border-t border-slate-700">
                    <div class="text-left">
                        <ul class="list-disc list-inside space-y-1 text-slate-300">
                            ${reasonsHTML}
                        </ul>
                    </div>
                    <div class="text-right flex items-center">
                        <span class="font-semibold text-xs mr-2">åŠ›åº¦</span>
                        ${strengthHTML}
                    </div>
                </div>
            </div>
        `;
    },

    async renderDetail(symbol) {
        const detailContainer = document.getElementById('detail-content');
        detailContainer.innerHTML = `<div class="loader mx-auto mt-10"></div>`;
        
        const stock = await this.fetchStockData(symbol, true);

        if (stock.error) {
            detailContainer.innerHTML = `<p class="text-red-500 text-center mt-10">${stock.error}</p>`;
            return;
        }
        
        document.getElementById('detail-header-title').textContent = `${symbol.replace(/\.US$|\.TW$/, '')} (${stock.name})`;
        
        detailContainer.innerHTML = `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-3xl font-bold ${stock.change >= 0 ? (stock.market === 'US' ? 'text-green-500' : 'text-red-500') : (stock.market === 'US' ? 'text-red-500' : 'text-green-500')}">${stock.currency}${stock.price.toFixed(2)}</p>
                        <p class="text-base mt-1 ${stock.change >= 0 ? (stock.market === 'US' ? 'text-green-500' : 'text-red-500') : (stock.market === 'US' ? 'text-red-500' : 'text-green-500')}">${stock.change >= 0 ? 'â–²' : 'â–¼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                    </div>
                    <div class="text-xs text-slate-400 text-right">
                        <p>ç•¶æ—¥ä½: <span class="font-semibold">${stock.low.toFixed(2)}</span></p>
                        <p>ç•¶æ—¥é«˜: <span class="font-semibold">${stock.high.toFixed(2)}</span></p>
                        <p>æˆäº¤é‡: <span class="font-semibold">${parseInt(stock.history[0].volume).toLocaleString('en-US')}</span></p>
                        ${stock.pe ? `<p>æœ¬ç›Šæ¯”: <span class="font-semibold">${stock.pe}</span></p>` : ''}
                    </div>
                </div>
            </div>
            <div class="flex bg-slate-700 rounded-lg p-1 mb-4">
                <button data-tab="analysis" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'analysis' ? 'bg-slate-800 shadow' : ''}">åˆ†æ</button>
                <button data-tab="chart" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'chart' ? 'bg-slate-800 shadow' : ''}">åœ–è¡¨</button>
                <button data-tab="news" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'news' ? 'bg-slate-800 shadow' : ''}">æ–°è</button>
            </div>
            <div id="detail-tab-content"></div>
        `;

        await this.renderDetailTabContent(symbol);

        detailContainer.querySelectorAll('.detail-tab').forEach(tab => {
            tab.addEventListener('click', async (e) => {
                this.state.detailViewTab = e.currentTarget.dataset.tab;
                await this.renderDetail(symbol);
            });
        });
    },

    async renderDetailTabContent(symbol) {
        const tabContainer = document.getElementById('detail-tab-content');
        switch(this.state.detailViewTab) {
            case 'analysis':
                tabContainer.innerHTML = this.getAnalysisContentHTML(symbol);
                document.getElementById('gemini-analysis-btn').addEventListener('click', () => this.handleGeminiAnalysis(symbol));
                break;
            case 'chart':
                tabContainer.innerHTML = this.getChartContentHTML(symbol);
                await this.renderAdvancedChart(symbol);
                document.querySelectorAll('.chart-timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const button = e.currentTarget;
                        const newTimeframe = button.dataset.timeframe;
                        
                        // ğŸ”§ é˜²æ­¢é‡è¤‡é»æ“Šå’Œæ·»åŠ éŒ¯èª¤è™•ç†
                        if (button.disabled || this.state.chartTimeframe === newTimeframe) {
                            return; // é¿å…é‡è¤‡è™•ç†
                        }
                        
                        try {
                            // æš«æ™‚ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼Œé˜²æ­¢å¿«é€Ÿé»æ“Š
                            document.querySelectorAll('.chart-timeframe-btn').forEach(b => b.disabled = true);
                            
                            console.log(`ğŸ”„ åˆ‡æ›åœ–è¡¨æ™‚é–“æ¡†æ¶: ${this.state.chartTimeframe} -> ${newTimeframe}`);
                            this.state.chartTimeframe = newTimeframe;
                            
                            await this.renderDetailTabContent(symbol);
                            console.log(`âœ… åœ–è¡¨åˆ‡æ›å®Œæˆ: ${newTimeframe}`);
                            
                        } catch (error) {
                            console.error('âŒ åœ–è¡¨åˆ‡æ›å¤±æ•—:', error);
                            // å¦‚æœåˆ‡æ›å¤±æ•—ï¼Œæ¢å¾©åˆ°ä¸Šä¸€å€‹ç‹€æ…‹
                            console.log('ğŸ”™ æ¢å¾©åˆ°ä¸Šä¸€å€‹æ™‚é–“æ¡†æ¶');
                        } finally {
                            // é‡æ–°å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
                            document.querySelectorAll('.chart-timeframe-btn').forEach(b => b.disabled = false);
                        }
                    });
                });
                break;
            case 'news':
                this.renderNews(symbol);
                break;
        }
    },

    getAnalysisContentHTML(symbol) {
        const stock = this.state.stockDataCache[symbol];
        const indicators = this.calculateIndicators(stock);
        const macdColor = indicators.macd.histogram >= 0 ? 'text-green-500' : 'text-red-500';
        const macdDirection = indicators.macd.histogram >= 0 ? 'å¤šé ­' : 'ç©ºé ­';

        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-bold mb-3">è¿‘ä¸ƒæ—¥åƒ¹æ ¼å€é–“</h3>
                <div class="space-y-3">${this.render7DayPriceVisual(symbol)}</div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-bold mb-3">æŠ€è¡“æŒ‡æ¨™åƒè€ƒ</h3>
                <div class="grid grid-cols-2 gap-3">
                    ${this.createAnalysisCard('RSI (14æ—¥)', `<span class="font-bold text-xl ${indicators.rsi > 70 ? 'text-red-500' : (indicators.rsi < 30 ? 'text-green-500' : '')}">${indicators.rsi.toFixed(2)}</span>`)}
                    ${this.createAnalysisCard('MACD (12,26,9)', `<span class="font-bold text-xl ${macdColor}">${indicators.macd.histogram.toFixed(2)}</span><br><span class="text-xs ${macdColor}">${macdDirection}å‹•èƒ½</span>`)}
                    ${this.createAnalysisCard('å¸ƒæ—é€šé“', `ä¸Šè»Œ: ${indicators.bb.upper.toFixed(2)}<br>ä¸‹è»Œ: ${indicators.bb.lower.toFixed(2)}`)}
                    ${this.createAnalysisCard('é‡åƒ¹é—œä¿‚', `5æ—¥å‡é‡æ¯”: <span class="font-bold text-xl">${(stock.history[0].volume / indicators.avgVol5).toFixed(2)}</span>`)}
                </div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                 <h3 class="text-lg font-bold mb-3">Gemini AI æ™ºæ…§è§£è®€</h3>
                 <button id="gemini-analysis-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full" ${this.state.isGeminiLoading ? 'disabled' : ''}>
                    ${this.state.isGeminiLoading ? 'åˆ†æä¸­...' : 'ç”ŸæˆæŠ€è¡“é¢åˆ†æ âœ¨'}
                 </button>
                 <div id="gemini-analysis-result" class="mt-4 p-3 bg-slate-700 rounded-lg text-slate-300 min-h-[100px] text-sm break-words">
                    é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI ç‚ºæ‚¨è§£è®€ç›®å‰çš„æŠ€è¡“æŒ‡æ¨™ã€‚
                 </div>
            </div>
        `;
    },

    getChartContentHTML() {
        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">K ç·šåœ–</h3>
                    <div class="flex bg-slate-700 rounded-lg p-1">
                        <button data-timeframe="5M" class="chart-timeframe-btn px-2 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === '5M' ? 'bg-slate-800 shadow' : ''}">5åˆ†ç·š</button>
                        <button data-timeframe="D" class="chart-timeframe-btn px-3 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === 'D' ? 'bg-slate-800 shadow' : ''}">æ—¥ç·š</button>
                        <button data-timeframe="W" class="chart-timeframe-btn px-3 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === 'W' ? 'bg-slate-800 shadow' : ''}">é€±ç·š</button>
                    </div>
                </div>
                <div class="advanced-chart-container">
                    <canvas id="advanced-chart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">MACD æŒ‡æ¨™</h3>
                </div>
                <div class="advanced-chart-container" style="height: 300px;">
                    <canvas id="macd-chart"></canvas>
                </div>
            </div>
        `;
    },

    async renderNews(symbol) {
        const tabContainer = document.getElementById('detail-tab-content');
        tabContainer.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl shadow-md"><div class="loader mx-auto"></div></div>`;

        try {
            const response = await fetch(`/api/get-stock-data?action=get_news&symbol=${symbol}`);
            const newsData = await response.json();

            if (!response.ok) {
                throw new Error(newsData.error || 'ç²å–æ–°èå¤±æ•—');
            }

            tabContainer.innerHTML = this.getNewsContentHTML(symbol, newsData);
        } catch (error) {
            tabContainer.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl shadow-md"><p class="text-red-500 text-center">${error.message}</p></div>`;
        }
    },

    getNewsContentHTML(symbol, newsItems) {
        let newsListHTML = '';
        if (newsItems && newsItems.length > 0) {
            newsListHTML = newsItems.map(item => {
                const date = new Date(item.datetime * 1000);
                const timeAgo = this.formatTimeAgo(date);
                return `
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block border-b border-slate-700 pb-3 last:border-b-0 hover:bg-slate-700 -mx-4 px-4 py-2 rounded-lg">
                        <h4 class="font-semibold text-base line-clamp-2">${item.headline}</h4>
                        <div class="text-xs text-slate-400 mt-1 flex justify-between">
                            <span>${item.source}</span>
                            <span>${timeAgo}</span>
                        </div>
                    </a>
                `;
            }).join('');
        } else {
            newsListHTML = `<p class="text-slate-400 text-center">æ‰¾ä¸åˆ°ç›¸é—œæ–°èã€‚</p>`;
        }
        
        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3">å¸‚å ´æ–°èèˆ‡è³‡è¨Š</h3>
                <div class="space-y-2">
                    ${newsListHTML}
                </div>
            </div>
        `;
    },

    formatTimeAgo(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " å¹´å‰";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " å€‹æœˆå‰";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " å¤©å‰";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " å°æ™‚å‰";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " åˆ†é˜å‰";
        return "å‰›å‰›";
    },
    
    render7DayPriceVisual(symbol) {
        const history = this.state.stockDataCache[symbol].history;
        if (!history || history.length === 0) return '';
        
        // ğŸ”§ ä¿®æ­£ï¼šå–æœ€è¿‘7å¤©çš„è³‡æ–™ (å¾ä»Šå¤©å¾€å‰æ¨)
        const last7Days = history.slice(-7).reverse(); // å–æœ€å¾Œ7å¤©ä¸¦åè½‰ç‚ºæœ€æ–°åœ¨å‰
        
        console.log('è¿‘ä¸ƒæ—¥åƒ¹æ ¼å€é–“è³‡æ–™:', {
            total_days: history.length,
            first_date: history[0]?.date,
            last_date: history[history.length - 1]?.date,
            selected_7_days: last7Days.map(d => ({ date: d.date, close: d.close }))
        });
        const allLows = last7Days.map(d => d.low);
        const allHighs = last7Days.map(d => d.high);
        const minPrice = Math.min(...allLows);
        const maxPrice = Math.max(...allHighs);
        const totalRange = maxPrice - minPrice;

        if (totalRange === 0) return '<p>åƒ¹æ ¼ç„¡æ³¢å‹•</p>';

        let html = '';
        last7Days.forEach(day => {
            const dayRange = day.high - day.low;
            const barWidth = (dayRange / totalRange) * 100;
            const barLeft = ((day.low - minPrice) / totalRange) * 100;
            const tickLeft = dayRange > 0 ? ((day.close - day.low) / dayRange) * 100 : 50;
            
            html += `
                <div class="flex items-center text-sm">
                    <span class="w-12 text-slate-400">${day.date.substring(5)}</span>
                    <div class="flex-1 price-range-bar-bg bg-slate-700 mx-2">
                        <div class="price-range-bar-fg bg-sky-800" style="width: ${barWidth}%; left: ${barLeft}%;">
                            <div class="price-range-bar-tick bg-sky-400" style="left: ${tickLeft}%;"></div>
                        </div>
                    </div>
                    <span class="w-28 text-right font-semibold text-slate-300">$${day.low.toFixed(2)}~${day.high.toFixed(2)}</span>
                </div>
            `;
        });
        return html;
    },

    calculateWeeklyData(dailyHistory, maxWeeks = null) {
        if (!dailyHistory || dailyHistory.length < 1) return [];

        // ç¢ºä¿æœ‰è¶³å¤ çš„æ—¥ç·šæ•¸æ“šä¾†ç”Ÿæˆé€±ç·š
        console.log('Daily history length for weekly calculation:', dailyHistory.length);

        const weeklyMap = new Map();
        // ä¸è¦åœ¨é€™è£¡ reverseï¼Œä¿æŒåŸæœ‰é †åºè™•ç†
        dailyHistory.forEach(day => {
            const date = new Date(day.date);
            const weekStartDate = new Date(date);
            weekStartDate.setDate(date.getDate() - date.getDay());
            const weekKey = weekStartDate.toISOString().split('T')[0];

            if (!weeklyMap.has(weekKey)) {
                weeklyMap.set(weekKey, {
                    open: day.open,
                    high: day.high,
                    low: day.low,
                    close: day.close,
                    volume: day.volume,
                    date: weekKey
                });
            } else {
                const week = weeklyMap.get(weekKey);
                week.high = Math.max(week.high, day.high);
                week.low = Math.min(week.low, day.low);
                week.close = day.close; // æœ€å¾Œä¸€å¤©çš„æ”¶ç›¤åƒ¹
                week.volume += day.volume;
            }
        });

        // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
        const weeklyData = Array.from(weeklyMap.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
        
        console.log('Generated weekly data length:', weeklyData.length);
        
        // å¦‚æœæŒ‡å®šäº†æœ€å¤§é€±æ•¸ï¼Œå‰‡é™åˆ¶è¿”å›çš„æ•¸æ“š
        if (maxWeeks && weeklyData.length > maxWeeks) {
            return weeklyData.slice(0, maxWeeks);
        }
        
        return weeklyData;
    },

    async renderAdvancedChart(symbol) {
        console.log('é–‹å§‹æ¸²æŸ“åœ–è¡¨ï¼Œsymbol:', symbol, 'timeframe:', this.state.chartTimeframe);
        
        // æ¸…ç†ç¾æœ‰åœ–è¡¨
        try {
            if (this.state.advancedChartInstance) {
                this.state.advancedChartInstance.destroy();
                this.state.advancedChartInstance = null;
            }
            if (this.state.macdChartInstance) {
                this.state.macdChartInstance.destroy();
                this.state.macdChartInstance = null;
            }
        } catch (cleanupError) {
            console.warn('æ¸…ç†åœ–è¡¨æ™‚å‡ºéŒ¯:', cleanupError);
        }
        
        try {
            // æª¢æŸ¥ Canvas å…ƒç´ æ˜¯å¦å­˜åœ¨
            const chartCanvas = document.getElementById('advanced-chart');
            const macdCanvas = document.getElementById('macd-chart');
        
        if (!chartCanvas || !macdCanvas) {
            console.error('Chart canvas elements not found:', {
                chartCanvas: !!chartCanvas,
                macdCanvas: !!macdCanvas
            });
            return;
        }
        
        // æ ¹æ“šæ™‚é–“æ¡†æ¶ç²å–ç›¸æ‡‰çš„æ•¸æ“š
        let stockData;
        if (this.state.chartTimeframe === '5M') {
            console.log(`ğŸ• é–‹å§‹ç²å– ${symbol} çš„5åˆ†ç·šæ•¸æ“š...`);
            stockData = await this.fetchStockData(symbol, true, '5M');
            console.log(`ğŸ• 5åˆ†ç·šæ•¸æ“šç²å–çµæœ:`, {
                success: !stockData?.error,
                error: stockData?.error,
                dataLength: stockData?.history?.length || 0,
                sampleData: stockData?.history?.slice(0, 2)
            });
        } else {
            stockData = this.state.stockDataCache[symbol];
        }
        
        if (!stockData || stockData.error) {
            console.error('ç„¡æ³•ç²å–è‚¡ç¥¨æ•¸æ“š:', stockData?.error || 'æ•¸æ“šä¸å­˜åœ¨');
            const ctx = chartCanvas.getContext('2d');
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('æ•¸æ“šè¼‰å…¥å¤±æ•—', chartCanvas.width / 2, chartCanvas.height / 2);
            return;
        }
        
        const history = stockData.history;
        let chartData;
        let macdData; // ç”¨æ–¼ MACD è¨ˆç®—çš„æ›´å¤šæ•¸æ“š
        let timeUnit;

        if (this.state.chartTimeframe === 'W') {
            // é€±ç·šéœ€è¦æ›´å¤šçš„æ—¥ç·šæ•¸æ“šä¾†ç”Ÿæˆè¶³å¤ çš„é€±ç·šæ•¸æ“š
            // ä½¿ç”¨æœ€å¤š350å¤©ï¼ˆç´„50é€± x 7å¤©ï¼‰çš„æ•¸æ“šä¾†ç¢ºä¿èƒ½ç”Ÿæˆè¶³å¤ çš„é€±ç·šæ•¸æ“š
            const dailyDataForWeekly = history.slice(0, Math.min(350, history.length));
            console.log('Daily data for weekly conversion:', dailyDataForWeekly.length);
            
            const weeklyData = this.calculateWeeklyData(dailyDataForWeekly, 50);
            chartData = weeklyData.slice(0, 35); // é¡¯ç¤º35é€±
            macdData = weeklyData; // MACDä½¿ç”¨å…¨éƒ¨é€±ç·šæ•¸æ“šï¼ˆ50é€±ï¼‰
            timeUnit = 'week';
            
            console.log('Weekly chart data:', chartData.length, 'MACD data:', macdData.length);
        } else if (this.state.chartTimeframe === '5M') {
            // 5åˆ†ç·šåœ–é¡¯ç¤ºç•¶å¤©æ‰€æœ‰æ•¸æ“š
            // ğŸ”§ ä¿®æ­£ï¼šä¸è¦ä¿®æ”¹åŸå§‹ history æ•¸çµ„ï¼Œå‰µå»ºå‰¯æœ¬ä¸¦åè½‰
            chartData = [...history].reverse(); // å‰µå»ºå‰¯æœ¬å¾Œåè½‰ï¼Œé¿å…å½±éŸ¿åŸå§‹æ•¸æ“š
            
            // 5åˆ†ç·š MACD éœ€è¦è¶³å¤ çš„æ­·å²æ•¸æ“šï¼Œå¦‚æœä¸å¤ å°±ä¸è¨ˆç®—
            if (history.length >= 26) {
                // å°æ–¼ MACD è¨ˆç®—ï¼Œä½¿ç”¨æ­£ç¢ºé †åºçš„æ•¸æ“šï¼ˆèˆŠåˆ°æ–°ï¼‰
                macdData = [...history]; // ä½¿ç”¨å‰¯æœ¬ï¼Œä¿æŒåŸå§‹é †åº
            } else {
                console.warn('Not enough 5min data for MACD, disabling MACD chart');
                macdData = null;
            }
            timeUnit = 'minute';
            
            console.log('5åˆ†ç·šæ•¸æ“šè™•ç†:', {
                originalLength: history.length,
                chartDataLength: chartData.length,
                firstOriginal: history[0]?.date,
                lastOriginal: history[history.length-1]?.date,
                firstChart: chartData[0]?.date,
                lastChart: chartData[chartData.length-1]?.date
            });
        } else {
            // ğŸ”§ ä¿®æ­£ï¼šå–æœ€å¾Œ30å¤©è³‡æ–™ (æœ€æ–°çš„è³‡æ–™)
            chartData = history.slice(-30); // å–æœ€å¾Œ30å¤©ï¼Œä¸éœ€è¦reverse
            
            // ğŸ”§ MACD è¨ˆç®—ï¼šç‚ºäº†ç¢ºä¿é¡¯ç¤ºç¯„åœä¸€è‡´ï¼ŒMACD ä¹Ÿä½¿ç”¨ç›¸åŒçš„30å¤©æ•¸æ“šç¯„åœ
            // ä½†ç‚ºäº†è¨ˆç®—æº–ç¢ºæ€§ï¼Œæˆ‘å€‘éœ€è¦æ›´å¤šæ­·å²æ•¸æ“šä¾†è¨ˆç®—EMAï¼Œç„¶å¾Œåªé¡¯ç¤ºæœ€å¾Œ30å¤©
            const macdDataLength = Math.min(100, history.length);
            if (macdDataLength >= 26) {
                // ä½¿ç”¨100å¤©æ•¸æ“šè¨ˆç®—ï¼Œä½†ç¢ºä¿ MACD çµæœèˆ‡ chartData çš„æ—¥æœŸç¯„åœåŒ¹é…
                macdData = history.slice(-macdDataLength); // å–æœ€å¾Œ100å¤©ç”¨æ–¼è¨ˆç®—
                console.log('MACD calculation will use', macdDataLength, 'days but display last 30 days to match K-line chart');
            } else {
                console.warn(`Not enough daily data for MACD (${macdDataLength}/26), disabling MACD chart`);
                macdData = null;
            }
            timeUnit = 'day';
            
            console.log('Daily chart data:', chartData.length, 'MACD data:', macdData?.length || 'disabled');
        }

        // é©—è­‰åœ–è¡¨æ•¸æ“š
        if (!chartData || chartData.length === 0) {
            console.error('Chart data is empty or invalid');
            return;
        }
        
        console.log('Chart data prepared:', {
            length: chartData.length,
            timeframe: this.state.chartTimeframe,
            sampleData: chartData.slice(0, 3),
            sampleDates: chartData.slice(0, 3).map(d => d.date),
            stockDataSource: this.state.chartTimeframe === '5M' ? 'fetchStockData(5M)' : 'cached data'
        });

        // ç¹ªè£½ K ç·šåœ–
        const ctx = chartCanvas.getContext('2d');
        
        // æº–å‚™åœ–è¡¨æ•¸æ“š - æ ¹æ“šåœ–è¡¨é¡å‹èª¿æ•´æ ¼å¼
        const chartType = Chart.controllers.CandlestickController ? 'candlestick' : 'line';
        
        let chartDatasets;
        if (chartType === 'candlestick') {
            // Kç·šåœ–æ•¸æ“šæ ¼å¼
            const data = chartData.map(d => {
                const timestamp = new Date(d.date).getTime();
                if (isNaN(timestamp)) {
                    console.warn('Invalid date found:', d.date);
                    return null;
                }
                return {
                    x: timestamp,
                    o: parseFloat(d.open) || 0,
                    h: parseFloat(d.high) || 0,
                    l: parseFloat(d.low) || 0,
                    c: parseFloat(d.close) || 0
                };
            }).filter(d => d !== null);
            
            chartDatasets = [{
                label: `${symbol} K-Line`,
                data: data,
                borderColor: '#94a3b8',
                color: {
                    up: '#22c55e',
                    down: '#ef4444',
                    unchanged: '#94a3b8'
                },
                borderWidth: 1
            }];
        } else {
            // ç·šåœ–æ•¸æ“šæ ¼å¼ï¼ˆæ”¶ç›¤åƒ¹ï¼‰
            const data = chartData.map(d => {
                const timestamp = new Date(d.date).getTime();
                if (isNaN(timestamp)) {
                    console.warn('Invalid date found:', d.date);
                    return null;
                }
                return {
                    x: timestamp,
                    y: parseFloat(d.close) || 0
                };
            }).filter(d => d !== null);
            
            chartDatasets = [{
                label: `${symbol} æ”¶ç›¤åƒ¹`,
                data: data,
                borderColor: '#0ea5e9',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 4
            }];
        }
        
        console.log('Processed chart data:', {
            chartType: chartType,
            datasetsLength: chartDatasets.length,
            firstDatasetLength: chartDatasets[0].data.length,
            sample: chartDatasets[0].data.slice(0, 2)
        });

        try {
            console.log(`Creating ${chartType} chart...`);
            
            this.state.advancedChartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    datasets: chartDatasets
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { 
                                unit: timeUnit,
                                displayFormats: {
                                    minute: 'HH:mm',
                                    day: 'MM/dd', 
                                    week: 'MM/dd'
                                }
                            },
                            grid: { 
                                color: 'rgba(71, 85, 105, 0.3)',
                                display: true
                            },
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 8
                            }
                        },
                        y: { 
                            grid: { 
                                color: 'rgba(71, 85, 105, 0.3)',
                                display: true
                            },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#475569',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('zh-TW');
                                },
                                label: function(context) {
                                    const d = context.raw;
                                    if (d.o !== undefined) {
                                        // Candlestick æ•¸æ“š
                                        return [
                                            `é–‹ç›¤: $${d.o?.toFixed(2) || 'N/A'}`,
                                            `æœ€é«˜: $${d.h?.toFixed(2) || 'N/A'}`,
                                            `æœ€ä½: $${d.l?.toFixed(2) || 'N/A'}`,
                                            `æ”¶ç›¤: $${d.c?.toFixed(2) || 'N/A'}`
                                        ];
                                    } else {
                                        // Line æ•¸æ“š
                                        return `${context.dataset.label}: $${context.parsed.y?.toFixed(2) || 'N/A'}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('K-line chart created successfully');
            
            // ç¹ªè£½ MACD åœ–è¡¨ï¼Œä½¿ç”¨æ›´å¤šçš„æ­·å²æ•¸æ“šé€²è¡Œè¨ˆç®—
            if (macdData && macdData.length >= 26) {
                console.log('Rendering MACD chart with data range:', {
                    macdDataLength: macdData.length,
                    chartDataLength: chartData.length,
                    macdFirstDate: macdData[0]?.date,
                    macdLastDate: macdData[macdData.length - 1]?.date,
                    chartFirstDate: chartData[0]?.date,
                    chartLastDate: chartData[chartData.length - 1]?.date,
                    timeUnit
                });
                this.renderMACDChart(symbol, macdData, timeUnit);
            } else {
                console.warn('Skipping MACD chart due to insufficient data');
                this.renderMACDPlaceholder();
            }
            
        } catch (error) {
            console.error('Error creating K-line chart:', error);
            
                // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.fillStyle = '#ef4444';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Kç·šåœ–å‰µå»ºå¤±æ•—: ' + error.message, chartCanvas.width / 2, chartCanvas.height / 2);
            }
        } catch (renderError) {
            console.error('âŒ renderAdvancedChart æ•´é«”éŒ¯èª¤:', renderError);
            // ç¢ºä¿UIä¸æœƒè¢«å¡ä½ï¼Œé¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
            const chartCanvas = document.getElementById('advanced-chart');
            const macdCanvas = document.getElementById('macd-chart');
            
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.fillStyle = '#ef4444';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('åœ–è¡¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', chartCanvas.width / 2, chartCanvas.height / 2);
            }
            
            if (macdCanvas) {
                const ctx = macdCanvas.getContext('2d');
                ctx.clearRect(0, 0, macdCanvas.width, macdCanvas.height);
                ctx.fillStyle = '#ef4444';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('MACD è¼‰å…¥å¤±æ•—', macdCanvas.width / 2, macdCanvas.height / 2);
            }
        }
    },

    renderMACDChart(symbol, macdData, timeUnit) {
        const macdCtx = document.getElementById('macd-chart');
        if (!macdCtx) {
            console.error('MACD chart canvas element not found');
            return;
        }
        
        const ctx = macdCtx.getContext('2d');
        const macdCalculation = this.calculateMACDHistory(macdData);
        
        // ğŸ”§ è©³ç´°æª¢æŸ¥æ•¸æ“š
        console.log('=== MACD åµéŒ¯è³‡è¨Š ===');
        console.log('åŸå§‹è³‡æ–™é•·åº¦:', macdData.length);
        console.log('åŸå§‹è³‡æ–™æ¨£æœ¬:', macdData.slice(0, 3).map(d => ({ date: d.date, close: d.close })));
        console.log('MACD è¨ˆç®—çµæœ:', macdCalculation);
        console.log('éé›¶æŸ±ç‹€åœ–å€¼:', macdCalculation.histogram.filter(v => v !== 0).length);
        console.log('æœ€å¾Œ10å€‹æŸ±ç‹€åœ–å€¼:', macdCalculation.histogram.slice(-10));
        
        // ğŸ”§ ä¿®æ­£ï¼šç¢ºä¿ MACD é¡¯ç¤ºç¯„åœèˆ‡ K ç·šåœ–å®Œå…¨ä¸€è‡´
        let displayLength, displayData, labels;
        
        if (timeUnit === 'week') {
            // é€±ç·šé¡¯ç¤ºå…¨éƒ¨æ•¸æ“š
            displayLength = macdData.length;
            displayData = {
                histogram: macdCalculation.histogram,
                macdLine: macdCalculation.macdLine,
                signalLine: macdCalculation.signalLine
            };
            labels = macdData.map(d => {
                const date = d.date.includes('T') ? d.date : d.date + 'T00:00:00Z';
                return new Date(date).getTime();
            });
        } else {
            // æ—¥ç·šï¼šé¡¯ç¤º MACD è¨ˆç®—çµæœçš„æœ€å¾Œ 30 å€‹æœ‰æ•ˆå€¼
            // ğŸ”§ é—œéµä¿®æ­£ï¼šæˆ‘å€‘éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„ MACD å€¼åŠå…¶å°æ‡‰çš„æ­£ç¢ºæ—¥æœŸ
            
            // é¦–å…ˆæ‰¾å‡ºæ‰€æœ‰æœ‰æ•ˆçš„ MACD æ•¸æ“šé»åŠå…¶ç´¢å¼•
            const validMacdIndices = [];
            for (let i = 0; i < macdCalculation.histogram.length; i++) {
                if (macdCalculation.histogram[i] !== null && 
                    macdCalculation.histogram[i] !== undefined && 
                    !isNaN(macdCalculation.histogram[i])) {
                    validMacdIndices.push(i);
                }
            }
            
            console.log('ğŸ”§ MACD FIX V2.0 - Found valid MACD indices:', {
                totalIndices: validMacdIndices.length,
                firstValidIndex: validMacdIndices[0],
                lastValidIndex: validMacdIndices[validMacdIndices.length - 1],
                firstValidDate: macdData[validMacdIndices[0]]?.date,
                lastValidDate: macdData[validMacdIndices[validMacdIndices.length - 1]]?.date,
                deployTime: new Date().toISOString()
            });
            
            // å–æœ€å¾Œ30å€‹æœ‰æ•ˆçš„MACDå€¼
            displayLength = Math.min(30, validMacdIndices.length);
            const displayIndices = validMacdIndices.slice(-displayLength);
            
            displayData = {
                histogram: displayIndices.map(i => macdCalculation.histogram[i]),
                macdLine: displayIndices.map(i => macdCalculation.macdLine[i]),
                signalLine: displayIndices.map(i => macdCalculation.signalLine[i])
            };
            
            // ğŸ”§ ä½¿ç”¨æ­£ç¢ºçš„æ—¥æœŸï¼šå°æ‡‰æœ‰æ•ˆMACDå€¼çš„å¯¦éš›æ—¥æœŸ
            labels = displayIndices.map(i => {
                const date = macdData[i].date.includes('T') ? macdData[i].date : macdData[i].date + 'T00:00:00Z';
                return new Date(date).getTime();
            });
            
            console.log('MACD corrected display range:', {
                displayLength,
                validIndicesUsed: displayIndices.slice(0, 5),
                firstDisplayDate: macdData[displayIndices[0]]?.date,
                lastDisplayDate: macdData[displayIndices[displayIndices.length - 1]]?.date,
                totalValidMacdPoints: validMacdIndices.length
            });
        }
        
        // ğŸ”§ æº–å‚™åœ–è¡¨æ•¸æ“š - ç¾åœ¨æ‰€æœ‰æ•¸æ“šéƒ½å·²ç¶“æ˜¯æœ‰æ•ˆçš„
        const validDataPoints = [];
        for (let i = 0; i < displayData.histogram.length; i++) {
            validDataPoints.push({
                index: i,
                timestamp: labels[i],
                histogram: displayData.histogram[i],
                macd: displayData.macdLine[i] !== null ? displayData.macdLine[i] : 0,
                signal: displayData.signalLine[i] !== null ? displayData.signalLine[i] : 0
            });
        }

        if (validDataPoints.length === 0) {
            console.warn('No valid MACD data points found, showing placeholder chart');
            ctx.clearRect(0, 0, macdCtx.width, macdCtx.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•è¨ˆç®— MACD', macdCtx.width / 2, macdCtx.height / 2);
            return;
        }

        console.log(`Found ${validDataPoints.length} valid MACD values out of ${displayData.histogram.length} total points`);
        console.log('Valid MACD range:', {
            firstDate: new Date(validDataPoints[0].timestamp).toLocaleDateString(),
            lastDate: new Date(validDataPoints[validDataPoints.length - 1].timestamp).toLocaleDateString(),
            sampleValues: validDataPoints.slice(0, 3).map(p => p.histogram)
        });

        // æº–å‚™æ™‚é–“è»¸æ•¸æ“š - åªä½¿ç”¨æœ‰æ•ˆæ•¸æ“šé»
        const timeAxisData = validDataPoints.map(point => ({
            x: point.timestamp,
            y: point.histogram
        }));
        
        const difLineData = validDataPoints.map(point => ({
            x: point.timestamp,
            y: point.macd
        }));
        
        const deaLineData = validDataPoints.map(point => ({
            x: point.timestamp,
            y: point.signal
        }));

        try {
            console.log('Creating MACD chart with the following data:', {
                validPoints: validDataPoints.length,
                timeRange: validDataPoints.length > 0 ? {
                    start: new Date(validDataPoints[0].timestamp).toLocaleDateString(),
                    end: new Date(validDataPoints[validDataPoints.length - 1].timestamp).toLocaleDateString()
                } : null,
                sampleHistogram: validDataPoints.slice(0, 5).map(p => p.histogram.toFixed(4)),
                timeUnit: timeUnit
            });
            this.state.macdChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: 'MACD æŸ±ç‹€åœ–',
                            data: timeAxisData,
                            backgroundColor: validDataPoints.map(point => 
                                point.histogram >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                            ),
                            borderColor: validDataPoints.map(point => 
                                point.histogram >= 0 ? '#16a34a' : '#dc2626'
                            ),
                            borderWidth: 1,
                            borderSkipped: false,
                            barThickness: 'flex',
                            maxBarThickness: 8,
                            order: 3
                        },
                        {
                            label: 'DIF',
                            data: difLineData,
                            type: 'line',
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            order: 1
                        },
                        {
                            label: 'DEA',
                            data: deaLineData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            order: 2
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { 
                                unit: timeUnit,
                                displayFormats: {
                                    minute: 'HH:mm',
                                    day: 'MM/dd',
                                    week: 'MM/dd'
                                }
                            },
                            // ğŸ”§ è¨­å®šæ˜ç¢ºçš„æ™‚é–“ç¯„åœï¼Œç¢ºä¿èˆ‡ K ç·šåœ–ä¸€è‡´
                            min: validDataPoints.length > 0 ? validDataPoints[0].timestamp : undefined,
                            max: validDataPoints.length > 0 ? validDataPoints[validDataPoints.length - 1].timestamp : undefined,
                            grid: { 
                                color: 'rgba(71, 85, 105, 0.3)',
                                display: true
                            },
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { 
                                color: 'rgba(71, 85, 105, 0.3)',
                                display: true
                            },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value.toFixed(4);
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                usePointStyle: true,
                                pointStyle: 'line',
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#475569',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('zh-TW');
                                },
                                label: function(context) {
                                    const datasetLabel = context.dataset.label;
                                    const value = context.parsed.y;
                                    
                                    if (datasetLabel === 'MACD æŸ±ç‹€åœ–') {
                                        const trend = value >= 0 ? 'å¤šé ­' : 'ç©ºé ­';
                                        return `${datasetLabel}: ${value.toFixed(4)} (${trend})`;
                                    } else {
                                        return `${datasetLabel}: ${value.toFixed(4)}`;
                                    }
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const histogram = context.parsed.y;
                                        return `è¶¨å‹¢å¼·åº¦: ${Math.abs(histogram).toFixed(4)}`;
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('MACD chart created successfully');
            
        } catch (error) {
            console.error('Error creating MACD chart:', error);
            
            // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
            ctx.clearRect(0, 0, macdCtx.width, macdCtx.height);
            ctx.fillStyle = '#ef4444';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('MACDåœ–å‰µå»ºå¤±æ•—: ' + error.message, macdCtx.width / 2, macdCtx.height / 2);
        }
    },

    renderMACDPlaceholder() {
        const macdCtx = document.getElementById('macd-chart');
        if (!macdCtx) return;
        
        const ctx = macdCtx.getContext('2d');
        ctx.clearRect(0, 0, macdCtx.width, macdCtx.height);
        ctx.fillStyle = '#94a3b8';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•è¨ˆç®— MACD æŒ‡æ¨™', macdCtx.width / 2, macdCtx.height / 2);
        ctx.fillText('(éœ€è¦è‡³å°‘ 26 å€‹æ•¸æ“šé»)', macdCtx.width / 2, macdCtx.height / 2 + 20);
    },

    calculateMACDHistory(chartData) {
        const closes = chartData.map(d => d.close);
        
        console.log('MACD calculation input:', {
            chartDataLength: chartData.length,
            closesLength: closes.length,
            sampleCloses: closes.slice(0, 5),
            sampleDates: chartData.slice(0, 5).map(d => d.date)
        });
        
        if (closes.length < 26) {
            console.warn('Not enough data for MACD calculation, need at least 26 data points, got:', closes.length);
            return {
                macdLine: new Array(chartData.length).fill(0),
                signalLine: new Array(chartData.length).fill(0),
                histogram: new Array(chartData.length).fill(0)
            };
        }
        
        // ç¢ºä¿æ•¸æ“šæ˜¯æŒ‰æ™‚é–“é †åºæ’åˆ—ï¼ˆæœ€èˆŠçš„åœ¨å‰é¢ï¼‰
        // æª¢æŸ¥æ•¸æ“šé †åºï¼Œå¦‚æœæ˜¯æ–°åˆ°èˆŠå‰‡éœ€è¦åè½‰
        const isNewestFirst = new Date(chartData[0].date) > new Date(chartData[chartData.length - 1].date);
        let orderedData = chartData;
        if (isNewestFirst) {
            orderedData = [...chartData].reverse();
            console.log('Reversed data order for MACD calculation');
        }
        
        const orderedCloses = orderedData.map(d => d.close);
        
        console.log('Ordered closes for MACD:', {
            length: orderedCloses.length,
            first5: orderedCloses.slice(0, 5),
            last5: orderedCloses.slice(-5),
            dates: { 
                first: orderedData[0].date, 
                last: orderedData[orderedData.length - 1].date 
            }
        });
        
        // EMA è¨ˆç®—å‡½æ•¸
        const calculateEMA = (data, period) => {
            const multiplier = 2 / (period + 1);
            let ema = new Array(data.length);
            
            // ç¬¬ä¸€å€‹ EMA å€¼ä½¿ç”¨ SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i];
            }
            ema[period - 1] = sum / period;
            
            // è¨ˆç®—å¾ŒçºŒ EMA å€¼
            for (let i = period; i < data.length; i++) {
                ema[i] = (data[i] - ema[i - 1]) * multiplier + ema[i - 1];
            }
            
            return ema;
        };
        
        // è¨ˆç®— 12æ—¥å’Œ26æ—¥ EMA
        const ema12 = calculateEMA(orderedCloses, 12);
        const ema26 = calculateEMA(orderedCloses, 26);
        
        // ğŸ”§ è¨ˆç®— MACD ç·š - ç¢ºä¿æœ‰æ›´å¤šæœ‰æ•ˆå€¼
        const macdLine = new Array(orderedCloses.length).fill(null);
        console.log('EMA è¨ˆç®—çµæœ:', {
            ema12_valid_from: ema12.findIndex(val => val !== undefined),
            ema26_valid_from: ema26.findIndex(val => val !== undefined),
            ema12_sample: ema12.slice(10, 15),
            ema26_sample: ema26.slice(20, 27)
        });
        
        for (let i = 25; i < orderedCloses.length; i++) { // å¾ç¬¬26å€‹æ•¸æ“šé»é–‹å§‹
            if (ema12[i] !== undefined && ema26[i] !== undefined) {
                macdLine[i] = ema12[i] - ema26[i];
            }
        }
        
        // ğŸ”§ ç²å–æœ‰æ•ˆçš„ MACD å€¼ä¾†è¨ˆç®— Signal ç·š
        const validMacdValues = [];
        for (let i = 25; i < orderedCloses.length; i++) {
            if (macdLine[i] !== null && macdLine[i] !== undefined) {
                validMacdValues.push(macdLine[i]);
            }
        }
        
        console.log('MACD å€¼çµ±è¨ˆ:', {
            total_length: macdLine.length,
            valid_macd_count: validMacdValues.length,
            first_valid_index: macdLine.findIndex(val => val !== null),
            sample_macd: validMacdValues.slice(0, 5)
        });
        
        // ğŸ”§ ä¿®æ­£ DEA (Signal) ç·šè¨ˆç®— - MACD ç·šçš„9æ—¥EMA
        const signalLine = new Array(orderedCloses.length).fill(null);
        
        if (validMacdValues.length >= 9) {
            console.log('è¨ˆç®— DEAï¼Œæœ‰æ•ˆ MACD å€¼æ•¸é‡:', validMacdValues.length);
            
            // ç›´æ¥å° MACD ç·šè¨ˆç®— EMAï¼Œè€Œä¸æ˜¯å° validMacdValues
            const macdEMA = calculateEMA(validMacdValues, 9);
            
            // å°‡ EMA çµæœæ˜ å°„å›åŸå§‹ä½ç½®
            let validIndex = 0;
            for (let i = 25; i < orderedCloses.length; i++) {
                if (macdLine[i] !== null && macdLine[i] !== undefined) {
                    // å¾ç¬¬9å€‹æœ‰æ•ˆ MACD å€¼é–‹å§‹æœ‰ Signal å€¼
                    if (validIndex >= 8 && macdEMA[validIndex] !== undefined) {
                        signalLine[i] = macdEMA[validIndex];
                    }
                    validIndex++;
                }
            }
            
            console.log('DEA è¨ˆç®—å®Œæˆï¼Œéé›¶å€¼æ•¸é‡:', signalLine.filter(v => v !== 0).length);
        } else {
            console.warn('MACD å€¼ä¸è¶³9å€‹ï¼Œç„¡æ³•è¨ˆç®— DEA:', validMacdValues.length);
        }
        
        // ğŸ”§ è¨ˆç®— Histogram (DIF - DEA)
        const histogram = new Array(orderedCloses.length).fill(null);
        for (let i = 0; i < orderedCloses.length; i++) {
            if (macdLine[i] !== null && signalLine[i] !== null) {
                histogram[i] = macdLine[i] - signalLine[i];
            } else if (macdLine[i] !== null) {
                // å¦‚æœæ²’æœ‰ DEA ç·šï¼Œé¡¯ç¤º DIF å€¼
                histogram[i] = macdLine[i];
            }
        }
        
        console.log('MACD calculation details:', {
            dataLength: orderedData.length,
            validMacdValues: validMacdValues.length,
            nonZeroHistogram: histogram.filter(val => val !== 0).length,
            sampleHistogram: histogram.slice(-10),
            sampleMacd: macdLine.slice(-10),
            sampleSignal: signalLine.slice(-10),
            dateRange: {
                first: orderedData[0]?.date,
                last: orderedData[orderedData.length - 1]?.date
            }
        });
        
        // å¦‚æœåŸå§‹æ•¸æ“šæ˜¯æ–°åˆ°èˆŠçš„é †åºï¼Œéœ€è¦å°‡çµæœä¹Ÿåè½‰å›å»
        let resultMacd = macdLine;
        let resultSignal = signalLine;
        let resultHistogram = histogram;
        
        if (isNewestFirst) {
            resultMacd = [...macdLine].reverse();
            resultSignal = [...signalLine].reverse();
            resultHistogram = [...histogram].reverse();
            console.log('Reversed results back to original order');
        }
        
        return {
            macdLine: resultMacd, // ä¿æŒ null å€¼ï¼Œè®“åœ–è¡¨æ­£ç¢ºè™•ç†
            signalLine: resultSignal,
            histogram: resultHistogram,
            dates: chartData.map(d => d.date)
        };
    },

    createAnalysisCard(title, content) {
        return `
            <div class="bg-slate-700 p-3 rounded-lg text-center">
                <h4 class="font-semibold text-slate-300 text-xs mb-1">${title}</h4>
                <div class="text-slate-400 text-sm leading-relaxed">${content}</div>
            </div>
        `;
    },

    selectStock(symbol) {
        this.state.previousView = this.state.currentView;
        this.state.selectedStock = symbol;
        this.state.detailViewTab = 'analysis';
        this.state.chartTimeframe = 'D'; // Reset to daily view
        this.renderDetail(symbol);
        const detailView = document.getElementById('view-detail');
        detailView.classList.remove('hidden');
        requestAnimationFrame(() => {
            detailView.classList.remove('translate-x-full');
        });
    },

    closeDetailView() {
        const detailView = document.getElementById('view-detail');
        detailView.classList.add('translate-x-full');
        setTimeout(() => {
            detailView.classList.add('hidden');
            this.state.selectedStock = null;
            if (this.state.advancedChartInstance) {
                this.state.advancedChartInstance.destroy();
                this.state.advancedChartInstance = null;
            }
            if (this.state.macdChartInstance) {
                this.state.macdChartInstance.destroy();
                this.state.macdChartInstance = null;
            }
            this.navigate(this.state.previousView);
        }, 300);
    },
    
    toggleModal(show) {
        const modal = document.getElementById('add-stock-modal');
        const feedbackEl = document.getElementById('add-stock-feedback');
        const inputEl = document.getElementById('add-stock-input');
        const promptEl = document.getElementById('add-stock-prompt');
        feedbackEl.textContent = '';
        inputEl.value = '';

        if (show) {
            const market = this.state.watchlistMarketView === 'TW' ? 'å°è‚¡' : 'ç¾è‚¡';
            const example = this.state.watchlistMarketView === 'TW' ? '2330' : 'AAPL';
            promptEl.textContent = `è«‹è¼¸å…¥${market}ä»£è™Ÿ (ä¾‹å¦‚: ${example})`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            inputEl.focus();
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    },

    async addStockFromInput() {
        const inputEl = document.getElementById('add-stock-input');
        const feedbackEl = document.getElementById('add-stock-feedback');
        const addButton = document.getElementById('modal-add-btn');
        let symbol = inputEl.value.trim().toUpperCase();

        if (!symbol) {
            feedbackEl.textContent = 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚';
            return;
        }

        if (!symbol.includes('.')) {
            const suffix = this.state.watchlistMarketView === 'TW' ? '.TW' : '.US';
            symbol += suffix;
        }

        // æ‹’çµ•å°è‚¡è«‹æ±‚
        if (symbol.includes('.TW')) {
            feedbackEl.textContent = 'ç›®å‰æš«ä¸æ”¯æ´å°è‚¡ï¼Œè«‹è¼¸å…¥ç¾è‚¡ä»£è™Ÿ';
            return;
        }

        if (this.state.watchlist.includes(symbol)) {
            feedbackEl.textContent = 'æ­¤è‚¡ç¥¨å·²åœ¨è‡ªé¸æ¸…å–®ä¸­ã€‚';
            return;
        }
        
        addButton.disabled = true;
        addButton.textContent = 'æ–°å¢ä¸­...';
        feedbackEl.textContent = '';

        const stockData = await this.fetchStockData(symbol, true);
        
        if (stockData.error) {
            feedbackEl.textContent = `æ–°å¢å¤±æ•—: ${stockData.error}`;
            addButton.disabled = false;
            addButton.textContent = 'æ–°å¢';
        } else {
            const newWatchlist = [symbol, ...this.state.watchlist];
            if (this.state.userId) { // Firebase mode
                this.state.db.collection('users').doc(this.state.userId).set({ watchlist: newWatchlist })
                    .then(() => this.toggleModal(false))
                    .catch(error => feedbackEl.textContent = `æ–°å¢å¤±æ•—: ${error.message}`);
            } else { // LocalStorage mode
                this.state.watchlist = newWatchlist;
                this.saveWatchlistToLocalStorage();
                this.render();
                this.toggleModal(false);
            }
            addButton.disabled = false;
            addButton.textContent = 'æ–°å¢';
        }
    },

    promptRemoveStock(symbol) {
        this.state.stockToRemove = symbol;
        const stockName = this.state.stockDataCache[symbol]?.name || symbol;
        document.getElementById('remove-stock-prompt').innerHTML = `ç¢ºå®šè¦å¾è‡ªé¸æ¸…å–®ä¸­ç§»é™¤ <strong class="text-sky-400">${stockName}</strong> å—ï¼Ÿ`;
        this.toggleRemoveModal(true);
    },

    toggleRemoveModal(show) {
        const modal = document.getElementById('confirm-remove-modal');
        if (show) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            this.state.stockToRemove = null;
        }
    },
    
    confirmRemoveStock() {
        const symbol = this.state.stockToRemove;
        if (!symbol) return;

        const newWatchlist = this.state.watchlist.filter(s => s !== symbol);
        if (this.state.userId) { // Firebase mode
            this.state.db.collection('users').doc(this.state.userId).set({ watchlist: newWatchlist })
                .catch(error => console.error("ç§»é™¤è‚¡ç¥¨å¤±æ•—:", error));
        } else { // LocalStorage mode
            this.state.watchlist = newWatchlist;
            this.saveWatchlistToLocalStorage();
            this.render();
        }
        this.toggleRemoveModal(false);
    },

    calculateIndicators(stockData) {
        const history = stockData.history;
        if (!history || history.length < 10) return { ma3: stockData.price || 0, ma5: stockData.price || 0, ma10: stockData.price || 0, ma20: stockData.price || 0, ma30: stockData.price || 0, rsi: 50, bb: { upper: 0, middle: 0, lower: 0 }, macd: { macd: 0, signal: 0, histogram: 0 }, high30: 0, low30: 0, avgVol5: 0 };
        const closes = history.map(d => d.close).reverse(); // Oldest to newest
        const volumes = history.map(d => d.volume).reverse();
        
        const sum = (arr) => arr.reduce((a, b) => a + b, 0);
        const avg = (arr) => sum(arr) / arr.length;
        const ma = (period) => closes.length >= period ? avg(closes.slice(-period)) : (closes.length > 0 ? avg(closes) : stockData.price || 0);
        
        // ğŸ”§ ä¿®æ­£ï¼š30æ—¥é«˜ä½åƒ¹æ‡‰è©²å–æœ€è¿‘30å¤©
        const high30 = history.length >= 30 ? Math.max(...history.slice(-30).map(d => d.high)) : (history.length > 0 ? Math.max(...history.map(d => d.high)) : stockData.high || stockData.price || 0);
        const low30 = history.length >= 30 ? Math.min(...history.slice(-30).map(d => d.low)) : (history.length > 0 ? Math.min(...history.map(d => d.low)) : stockData.low || stockData.price || 0);
        const avgVol5 = volumes.length >= 5 ? avg(volumes.slice(-5)) : (volumes.length > 0 ? avg(volumes) : 0);

        let gains = 0, losses = 0;
        const rsiPeriod = Math.min(14, closes.length - 1);
        if (rsiPeriod > 0) {
            for (let i = closes.length - rsiPeriod; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                if (diff > 0) gains += diff; else losses -= diff;
            }
        }
        const rs = (rsiPeriod > 0 && losses > 0) ? (gains / rsiPeriod) / (losses / rsiPeriod) : 1;
        const rsi = isFinite(rs) ? 100 - (100 / (1 + rs)) : 50;

        const ma20 = ma(20);
        const bbPeriod = Math.min(20, closes.length);
        const bbCloses = closes.slice(-bbPeriod);
        const stdDev = bbCloses.length > 1 ? Math.sqrt(avg(bbCloses.map(p => Math.pow(p - ma20, 2)))) : 0;
        const bb = { upper: ma20 + (stdDev * 2), middle: ma20, lower: ma20 - (stdDev * 2) };

        // MACD Calculation
        const ema = (data, period) => {
            const multiplier = 2 / (period + 1);
            let emaArray = [avg(data.slice(0, period))];
            for (let i = period; i < data.length; i++) {
                const newEma = (data[i] - emaArray[emaArray.length - 1]) * multiplier + emaArray[emaArray.length - 1];
                emaArray.push(newEma);
            }
            return emaArray;
        };
        const ema12 = ema(closes, 12);
        const ema26 = ema(closes, 26);
        const macdLine = ema12.slice(-ema26.length).map((val, idx) => val - ema26[idx]);
        const signalLine = ema(macdLine, 9);
        const macd = {
            macd: macdLine[macdLine.length - 1],
            signal: signalLine[signalLine.length - 1],
            histogram: macdLine[macdLine.length - 1] - signalLine[signalLine.length - 1],
            prevMacd: macdLine[macdLine.length - 2],
            prevSignal: signalLine[signalLine.length - 2],
        };

        return { ma3: ma(3), ma5: ma(5), ma10: ma(10), ma20, ma30: ma(30), rsi, bb, macd, high30, low30, avgVol5 };
    },

    getSignals(symbol, stock, indicators) {
        const buyReasons = [], sellReasons = [];
        if (indicators.rsi < 35) buyReasons.push('RSI æ¥è¿‘è¶…è³£å€');
        if (stock.price <= indicators.bb.lower * 1.01) buyReasons.push('è‚¡åƒ¹æ¥è¿‘å¸ƒæ—é€šé“ä¸‹è»Œ');
        if (stock.price <= indicators.ma10 && stock.price >= indicators.ma10 * 0.98) buyReasons.push('è‚¡åƒ¹å›æ¸¬10æ—¥ç·š');
        if (stock.history[0].volume > indicators.avgVol5 * 1.5 && stock.change > 0) buyReasons.push('åƒ¹æ¼²é‡å¢');
        if (indicators.macd.prevMacd < indicators.macd.prevSignal && indicators.macd.macd > indicators.macd.signal) buyReasons.push('MACD é»ƒé‡‘äº¤å‰');

        if (indicators.rsi > 65) sellReasons.push('RSI æ¥è¿‘è¶…è²·å€');
        if (stock.price >= indicators.bb.upper * 0.99) sellReasons.push('è‚¡åƒ¹æ¥è¿‘å¸ƒæ—é€šé“ä¸Šè»Œ');
        if (stock.price / indicators.ma5 > 1.08) sellReasons.push('è‚¡åƒ¹èˆ‡5æ—¥ç·šä¹–é›¢éå¤§');
        if (stock.history[0].volume > indicators.avgVol5 * 1.5 && stock.change < 0) sellReasons.push('åƒ¹è·Œé‡å¢');
        if (indicators.macd.prevMacd > indicators.macd.prevSignal && indicators.macd.macd < indicators.macd.signal) sellReasons.push('MACD æ­»äº¡äº¤å‰');

        return {
            buy: { reasons: buyReasons, score: Math.min(buyReasons.length, 3) },
            sell: { reasons: sellReasons, score: Math.min(sellReasons.length, 3) }
        };
    },
    
    async handleGeminiAnalysis(symbol) {
        if (this.state.isGeminiLoading) return;
        this.state.isGeminiLoading = true;
        const resultContainer = document.getElementById('gemini-analysis-result');
        const analysisBtn = document.getElementById('gemini-analysis-btn');
        analysisBtn.disabled = true;
        analysisBtn.innerHTML = 'åˆ†æä¸­...';
        resultContainer.innerHTML = '<div class="loader"></div>';
        
        const stock = this.state.stockDataCache[symbol];
        const indicators = this.calculateIndicators(stock);
        
        try {
            const response = await fetch('/api/get-stock-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock, indicators })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `API è«‹æ±‚å¤±æ•—: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.analysis) {
                resultContainer.innerHTML = this.formatGeminiResponse(result.analysis);
            } else {
                throw new Error('å¾ API æ”¶åˆ°çš„å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºã€‚');
            }

        } catch (error) {
            resultContainer.innerHTML = `<p class="text-red-500">åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</p>`;
        } finally {
            this.state.isGeminiLoading = false;
            analysisBtn.disabled = false;
            analysisBtn.innerHTML = 'é‡æ–°ç”Ÿæˆåˆ†æ âœ¨';
        }
    },

    formatGeminiResponse(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-100 block mb-2">$1</strong>');
        
        const listItemsRegex = /(\* .+(\n|$))+/g;
        html = html.replace(listItemsRegex, (match) => {
            const items = match.trim().split('\n');
            const listHtml = items.map(item => `<li class="mb-1">${item.substring(2).trim()}</li>`).join('');
            return `<ul class="list-disc list-inside space-y-1">${listHtml}</ul>`;
        });
        
        return html;
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());

// è¨»å†Š Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(registration => {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

</body>
</html>
