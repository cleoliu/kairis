<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kairis</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icons/icon-192x192.png">
    <!-- Chosen Palette: Warm Neutrals (Slate & Sky) - Dark Mode -->
    <!-- Application Structure Plan: A mobile-first SPA with a fixed bottom tab bar for primary navigation between "Watchlist" and "Scanner". The "Detail" view is now a separate, full-screen view that appears on top of the current view, with a dedicated back button, which is a standard mobile UI pattern. The watchlist itself is now sub-tabbed for "TW" and "US" markets. This architecture prioritizes mobile ergonomics, one-handed operation, and clear information separation. -->
    <!-- Visualization & Content Choices: 
        - [Stock List]: Goal: Inform/Compare. Method: A single-column list of cards. Now includes key indicators (High, Low, MAs) with a conditional star '★' to indicate when price is below a MA. Interaction: Click to navigate to detail view. Justification: The star provides an immediate visual cue for potential weakness.
        - [Detail Page Tabs]: Goal: Organize. Method: A new sub-tab navigation for Analysis, Chart, and News. Justification: Organizes a growing amount of information on the detail page into logical sections, preventing cognitive overload.
        - [Advanced Chart]: Goal: Analyze Change. Method: Upgraded to a Chart.js Candlestick chart using a financial plugin, showing 30-day OHLC data. Now includes Daily/Weekly timeframe switching. Interaction: Hover/touch for tooltips with full OHLC info, click to switch timeframe. Justification: Fulfills user request for a more professional K-line chart with multiple timeframes.
        - [News Feed]: Goal: Inform. Method: A list of mock news articles. Justification: Adds a qualitative, event-driven context to the quantitative data.
        - [7-Day Price Visual]: Goal: Analyze Change/Compare. Method: Custom HTML/CSS visualization. Displays the full high-low range as text. Interaction: Static display. Justification: Implements user's visual preference.
        - [Scanner]: Goal: Organize/Discover. Method: Single-column list of cards. Now tabbed by market (TW/US). Layout adjusted to prioritize price info over the reason. Interaction: Click to navigate to detail view. Justification: Aligns with user workflow of seeing price first and filtering by market.
        - [Add Stock]: Goal: Input. Method: Text input now intelligently appends market suffix based on the active tab. Interaction: User types symbol and clicks add. Justification: A significant usability improvement.
        - [Theme]: The app is now set to a permanent dark theme.
        - [Last Updated]: Goal: Inform. Method: A simple text element on each main view. Interaction: Static. Justification: Provides crucial context on data freshness.
        - [Gemini Analysis]: Goal: Synthesize/Explain. Method: Button-triggered text block. Interaction: Click to generate analysis.
        - Library/Method: Vanilla JS for all logic, Gemini API for AI analysis, Chart.js with chartjs-chart-financial plugin for advanced chart.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }
        .app-container {
            max-width: 440px; /* Mobile first */
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding-bottom: 64px; /* Space for bottom nav */
        }
        
        /* Tablet styles (iPad) */
        @media (min-width: 768px) and (max-width: 1023.98px) {
            .app-container {
                max-width: 100%;
                padding-bottom: 64px; /* Keep space for bottom nav */
                box-shadow: none;
            }
            
            .header-desktop {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                max-width: 100% !important;
                z-index: 10;
            }
            
            .main-desktop {
                padding-top: 5rem !important; /* Space for fixed header */
                max-height: calc(100vh - 140px);
            }
            
            .bottom-nav-desktop {
                display: flex !important; /* Show bottom nav on iPad */
                max-width: 100% !important;
            }
            
            .sidebar-desktop {
                display: none; /* Hide sidebar on iPad */
            }
            
            /* Two-column grid for cards on iPad */
            #stock-list-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
            
            #buy-opportunities,
            #sell-opportunities {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
        }
        
        /* Desktop styles */
        @media (min-width: 1024px) {
            .app-container {
                max-width: 100%;
                display: grid;
                grid-template-columns: 280px 1fr;
                grid-template-rows: 1fr;
                grid-template-areas: 
                    "sidebar main";
                padding-bottom: 0;
                height: 100vh;
                box-shadow: none;
            }
            
            .header-desktop {
                display: none; /* Hide header on desktop */
            }
            
            .main-desktop {
                grid-area: main;
                padding: 1rem !important;
                border-left: 1px solid #374151;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .sidebar-desktop {
                grid-area: sidebar;
                background-color: #1e293b;
                border-right: 1px solid #374151;
                display: flex;
                flex-direction: column;
                padding: 1rem;
            }
            
            .bottom-nav-desktop {
                display: none;
            }
            
            .nav-item-desktop {
                padding: 0.75rem 1rem;
                margin-bottom: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background-color 0.2s;
                color: #94a3b8;
                font-weight: 600;
            }
            
            .nav-item-desktop:hover {
                background-color: #374151;
            }
            
            .nav-item-desktop.active {
                background-color: #0ea5e9;
                color: white;
            }
            
            /* Two-column grid for cards on desktop */
            .stock-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .opportunity-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            /* Detail view adjustments for desktop */
            #view-detail {
                position: fixed !important;
                inset: 0 !important;
                transform: none !important;
                z-index: 30 !important;
            }
        }
        main {
            transition: transform 0.3s ease;
        }
        #pull-to-refresh-indicator {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        .strength-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 5px solid #475569; /* slate-600 */
            border-bottom-color: #0ea5e9; /* sky-500 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .price-range-bar-bg {
            height: 20px;
            border-radius: 4px;
            position: relative;
        }
        .price-range-bar-fg {
            height: 100%;
            position: absolute;
        }
        .price-range-bar-tick {
            width: 2px;
            height: 100%;
            position: absolute;
        }
        .ma-star {
            color: #f59e0b; /* amber-500 */
            font-weight: bold;
        }
        .advanced-chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-black text-slate-200 font-sans transition-colors duration-300">

    <div id="app" class="app-container bg-slate-900 flex flex-col h-screen">
        
        <!-- Desktop Sidebar (hidden on mobile) -->
        <aside class="sidebar-desktop hidden lg:flex">
            <h1 class="text-xl font-bold text-white mb-6">Kairis</h1>
            <nav class="flex-1">
                <div class="nav-item-desktop active" data-view="watchlist">
                    <span class="text-sm font-semibold">自選列表</span>
                </div>
                <div class="nav-item-desktop" data-view="scanner">
                    <span class="text-sm font-semibold">機會掃描</span>
                </div>
                
                <!-- Market selection for desktop -->
                <div id="desktop-market-controls" class="mt-6 mb-4">
                    <div class="mb-3">
                        <div class="flex bg-slate-700 rounded-lg p-1">
                            <button data-market="US" class="desktop-market-tab flex-1 px-3 py-2 text-sm font-semibold rounded-md text-slate-300">美股</button>
                            <button data-market="TW" class="desktop-market-tab flex-1 px-3 py-2 text-sm font-semibold rounded-md text-slate-300">台股</button>
                        </div>
                    </div>
                    <button id="desktop-add-stock-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                        + 新增股票
                    </button>
                </div>
            </nav>
            <div id="sidebar-auth-section" class="mt-auto pt-4 border-t border-slate-700">
                <!-- Auth content will be injected here -->
            </div>
        </aside>
        
        <header id="main-header" class="fixed top-0 left-0 right-0 max-w-md mx-auto bg-slate-800 flex-shrink-0 z-10 p-4 border-b border-slate-700 md:max-w-full lg:hidden header-desktop">
             <!-- Header content is injected by JS -->
        </header>

        <main class="p-4 pt-20 relative flex-grow overflow-y-auto lg:pt-4 main-desktop">
             <div id="pull-to-refresh-indicator">
                <div class="loader !w-6 !h-6 !border-4"></div>
            </div>
            <!-- Watchlist View -->
            <div id="view-watchlist" class="view">
                <p id="watchlist-last-updated" class="text-xs text-slate-500 text-right mb-2"></p>
                <div id="stock-list-container" class="space-y-3">
                    <!-- Stock cards will be injected here -->
                </div>
            </div>

            <!-- Scanner View -->
            <div id="view-scanner" class="view hidden">
                <p id="scanner-last-updated" class="text-xs text-slate-500 text-right mb-2"></p>
                <p class="text-sm text-slate-400">本頁面會自動掃描您自選列表中的所有股票，並根據預設的技術指標，篩選出符合特定條件的潛在買賣機會。</p>
                <div class="space-y-6 mt-4">
                    <div>
                        <h3 class="text-lg font-semibold text-green-500 mb-2">潛在買進機會</h3>
                        <div id="buy-opportunities" class="space-y-3">
                            <!-- Buy opportunity cards will be injected here -->
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-red-500 mb-2">潛在賣出機會</h3>
                        <div id="sell-opportunities" class="space-y-3">
                            <!-- Sell opportunity cards will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail View - Now acts as a full-page overlay -->
    <div id="view-detail" class="fixed inset-0 bg-slate-900 z-20 hidden transform translate-x-full transition-transform duration-300 app-container">
        <header class="bg-slate-800 sticky top-0 z-10 p-4 border-b border-slate-700 flex items-center">
            <button id="back-btn" class="text-sky-500 text-2xl mr-4 w-8 h-8 flex items-center justify-center active:bg-slate-700 rounded-full">‹</button>
            <h2 id="detail-header-title" class="text-lg font-bold truncate">個股詳情</h2>
        </header>
        <div id="detail-content-wrapper" class="overflow-y-auto h-[calc(100vh-65px)]">
             <div id="detail-content" class="p-4">
                <!-- Detail content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (hidden on desktop) -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-800 border-t border-slate-700 flex justify-around h-16 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] md:max-w-full lg:hidden bottom-nav-desktop">
        <button data-view="watchlist" class="bottom-nav-tab flex flex-col items-center justify-center text-sky-500 w-full active:bg-slate-700 transition-colors">
            <span class="text-sm font-semibold">自選列表</span>
        </button>
        <button data-view="scanner" class="bottom-nav-tab flex flex-col items-center justify-center text-slate-400 w-full active:bg-slate-700 transition-colors">
            <span class="text-sm font-semibold">機會掃描</span>
        </button>
    </nav>

    <!-- Add Stock Modal -->
    <div id="add-stock-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">新增股票</h3>
            <p id="add-stock-prompt" class="text-slate-400 mb-2"></p>
            <input type="text" id="add-stock-input" class="w-full border border-slate-600 rounded-md p-2 bg-slate-700" placeholder="輸入代號...">
            <p id="add-stock-feedback" class="text-xs text-red-500 mt-1 h-4"></p>
            <div class="flex gap-2 mt-4">
                 <button id="modal-add-btn" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">新增</button>
                 <button id="close-modal-btn" class="flex-1 bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2 px-4 rounded-lg">取消</button>
            </div>
        </div>
    </div>

    <!-- Confirm Remove Modal -->
    <div id="confirm-remove-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">確認刪除</h3>
            <p id="remove-stock-prompt" class="text-slate-300 mb-6"></p>
            <div class="flex gap-2">
                 <button id="confirm-remove-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定</button>
                 <button id="cancel-remove-btn" class="flex-1 bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2 px-4 rounded-lg">取消</button>
            </div>
        </div>
    </div>


<script>
// *** START: Firebase Integration ***
const firebaseConfig = {
apiKey: "AIzaSyCbny5Pe0tbUI91H6Fd39mC-lhxcQDvOkk",
authDomain: "kairis-2ff35.firebaseapp.com",
projectId: "kairis-2ff35",
storageBucket: "kairis-2ff35.firebasestorage.app",
messagingSenderId: "720426426161",
appId: "1:720426426161:web:9c85abf4eacfc84be5da10",
measurementId: "G-75W5RT06MP"
};
// *** END: Firebase Integration ***

const App = {
    state: {
        currentView: 'watchlist',
        watchlistMarketView: 'US',
        scannerMarketView: 'US',
        watchlist: [], 
        selectedStock: null,
        stockToRemove: null,
        detailViewTab: 'analysis',
        chartTimeframe: 'D',
        previousView: 'watchlist',
        isGeminiLoading: false,
        lastUpdated: null,
        advancedChartInstance: null,
        macdChartInstance: null,
        stockDataCache: {},
        newsCache: {},
        isLoading: false,
        db: null,
        auth: null,
        userId: null,
        user: null,
        watchlistUnsubscribe: null,
    },

    async init() {
        this.setupEventListeners();
        this.setupPullToRefresh();
        this.updateTime();
        await this.initFirebase();
        setInterval(() => {
            this.updateTime();
            if(this.state.currentView !== 'detail') {
                this.fetchAllWatchlistData(true);
            }
        }, 60000);
    },

    async initFirebase() {
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn("Firebase 未設定，自選股清單將儲存在本機瀏覽器中。");
            this.loadWatchlistFromLocalStorage();
            return;
        }

        try {
            firebase.initializeApp(firebaseConfig);
            this.state.db = firebase.firestore();
            this.state.auth = firebase.auth();

            this.state.auth.onAuthStateChanged(user => {
                this.state.user = user;
                if (user) {
                    this.state.userId = user.uid;
                    console.log("用戶已登入:", user.uid);
                    this.loadWatchlistFromFirestore();
                } else {
                    console.log("開始匿名登入...");
                    this.state.auth.signInAnonymously()
                        .then(() => {
                            console.log("匿名登入成功");
                        })
                        .catch(error => {
                            console.error("匿名登入失敗:", error);
                            this.loadWatchlistFromLocalStorage();
                        });
                }
                this.renderHeader();
            });
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
            this.loadWatchlistFromLocalStorage();
        }
    },

    loadWatchlistFromFirestore() {
        if (this.state.watchlistUnsubscribe) {
            this.state.watchlistUnsubscribe();
        }
        if (!this.state.db || !this.state.userId) {
            console.log("Firebase 或用戶 ID 未準備好，使用本地存儲");
            this.loadWatchlistFromLocalStorage();
            return;
        }

        console.log("從 Firestore 載入 watchlist，用戶 ID:", this.state.userId);
        const docRef = this.state.db.collection('users').doc(this.state.userId);
        
        this.state.watchlistUnsubscribe = docRef.onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                let watchlistData = Array.isArray(data.watchlist) ? data.watchlist : [];
                // 過濾掉台股，只保留美股
                this.state.watchlist = watchlistData.filter(symbol => !symbol.includes('.TW'));
            } else {
                this.state.watchlist = ['AAPL.US'];
                docRef.set({ watchlist: this.state.watchlist });
            }
            this.fetchAllWatchlistData();
        }, error => {
            console.error("讀取 watchlist 失敗:", error);
        });
    },
    
    loadWatchlistFromLocalStorage() {
        const saved = localStorage.getItem('stockwise_watchlist');
        let savedWatchlist = saved ? JSON.parse(saved) : ['AAPL.US'];
        // 過濾掉台股，只保留美股
        this.state.watchlist = savedWatchlist.filter(symbol => !symbol.includes('.TW'));
        this.fetchAllWatchlistData();
    },

    saveWatchlistToLocalStorage() {
        localStorage.setItem('stockwise_watchlist', JSON.stringify(this.state.watchlist));
    },

    updateTime() {
        this.state.lastUpdated = new Date();
    },

    async fetchStockData(symbol, forceRefresh = false, timeframe = null) {
        const cacheKey = timeframe === '5M' ? `${symbol}_5M` : symbol;
        
        if (this.state.stockDataCache[cacheKey] && !this.state.stockDataCache[cacheKey].error && !forceRefresh) {
            console.log(`Using cached data for ${symbol}${timeframe ? ` (${timeframe})` : ''}`);
            return this.state.stockDataCache[cacheKey];
        }
        
        this.state.stockDataCache[cacheKey] = { isLoading: true };

        try {
            const url = timeframe ? `/api/get-stock-data?symbol=${symbol}&timeframe=${timeframe}` : `/api/get-stock-data?symbol=${symbol}`;
            console.log(`[${new Date().toISOString()}] Fetching data from API for ${symbol}${timeframe ? ` (${timeframe})` : ''}`);
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                console.error(`API error for ${symbol}:`, data.error);
                const errorData = { error: data.error || '獲取資料失敗' };
                this.state.stockDataCache[cacheKey] = errorData;
                return errorData;
            }
            
            const market = symbol.endsWith('.TW') ? 'TW' : 'US';
            const currency = market === 'TW' ? 'NT$' : '$';
            const processedData = { ...data, name: data.name || symbol, market, currency, pe: data.pe || null };
            this.state.stockDataCache[cacheKey] = processedData;
            return processedData;

        } catch (error) {
            const errorData = { error: '網路請求失敗' };
            this.state.stockDataCache[cacheKey] = errorData;
            return errorData;
        }
    },

    async fetchAllWatchlistData(forceRefresh = false) {
        if (!forceRefresh) {
            this.state.isLoading = true;
            this.render();
        }

        // 過濾掉台股，只處理美股
        const symbolsToFetch = this.state.watchlist
            .filter(symbol => !symbol.includes('.TW'))
            .filter(symbol => !this.state.stockDataCache[symbol] || forceRefresh);
        
        const promises = symbolsToFetch.map(symbol => this.fetchStockData(symbol, forceRefresh));

        await Promise.all(promises);

        this.state.isLoading = false;
        this.render();
    },

    setupEventListeners() {
        // Mobile bottom navigation
        document.querySelectorAll('.bottom-nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view));
        });
        
        // Desktop sidebar navigation
        document.querySelectorAll('.nav-item-desktop').forEach(item => {
            item.addEventListener('click', (e) => this.navigate(e.currentTarget.dataset.view));
        });
        
        // Desktop market tabs
        document.querySelectorAll('.desktop-market-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                if (this.state.currentView === 'watchlist') {
                    this.state.watchlistMarketView = e.currentTarget.dataset.market;
                } else if (this.state.currentView === 'scanner') {
                    this.state.scannerMarketView = e.currentTarget.dataset.market;
                }
                this.render();
            });
        });
        
        // Desktop add stock button
        const desktopAddBtn = document.getElementById('desktop-add-stock-btn');
        if (desktopAddBtn) {
            desktopAddBtn.addEventListener('click', () => this.toggleModal(true));
        }
        
        document.getElementById('back-btn').addEventListener('click', () => this.closeDetailView());
        document.getElementById('close-modal-btn').addEventListener('click', () => this.toggleModal(false));
        document.getElementById('modal-add-btn').addEventListener('click', () => this.addStockFromInput());
        document.getElementById('cancel-remove-btn').addEventListener('click', () => this.toggleRemoveModal(false));
        document.getElementById('confirm-remove-btn').addEventListener('click', () => this.confirmRemoveStock());
    },

    setupPullToRefresh() {
        const mainEl = document.querySelector('main');
        let startY = 0;
        let pullDistance = 0;
        const refreshThreshold = 80;

        mainEl.addEventListener('touchstart', (e) => {
            if (mainEl.scrollTop === 0 && this.state.currentView !== 'detail') {
                startY = e.touches[0].pageY;
            }
        }, { passive: true });

        mainEl.addEventListener('touchmove', (e) => {
            if (mainEl.scrollTop === 0 && startY > 0) {
                const currentY = e.touches[0].pageY;
                pullDistance = currentY - startY;
                if (pullDistance > 0) {
                    mainEl.style.transform = `translateY(${Math.min(pullDistance, refreshThreshold * 1.5)}px)`;
                }
            }
        }, { passive: true });

        mainEl.addEventListener('touchend', async () => {
            if (pullDistance > refreshThreshold) {
                mainEl.style.transform = `translateY(50px)`;
                await this.fetchAllWatchlistData(true);
                mainEl.style.transform = 'translateY(0px)';
            } else {
                mainEl.style.transform = 'translateY(0px)';
            }
            startY = 0;
            pullDistance = 0;
        });
    },

    navigate(view) {
        if (!view) return;
        this.state.currentView = view;
        this.render();
    },

    render() {
        this.renderHeader();
        
        document.querySelectorAll('#app > main > .view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${this.state.currentView}`).classList.remove('hidden');

        // Update mobile bottom navigation
        document.querySelectorAll('.bottom-nav-tab').forEach(tab => {
            tab.classList.remove('text-sky-500');
            tab.classList.add('text-slate-400');
        });
        const activeTab = document.querySelector(`.bottom-nav-tab[data-view="${this.state.currentView}"]`);
        if (activeTab) {
            activeTab.classList.add('text-sky-500');
            activeTab.classList.remove('text-slate-400');
        }

        // Update desktop sidebar navigation
        document.querySelectorAll('.nav-item-desktop').forEach(item => {
            item.classList.remove('active');
        });
        const activeDesktopItem = document.querySelector(`.nav-item-desktop[data-view="${this.state.currentView}"]`);
        if (activeDesktopItem) {
            activeDesktopItem.classList.add('active');
        }

        // Update desktop market tabs
        document.querySelectorAll('.desktop-market-tab').forEach(tab => {
            tab.classList.remove('bg-slate-800', 'shadow', 'text-white');
            tab.classList.add('text-slate-300');
        });
        
        const currentMarketView = this.state.currentView === 'watchlist' ? this.state.watchlistMarketView : this.state.scannerMarketView;
        document.querySelectorAll(`.desktop-market-tab[data-market="${currentMarketView}"]`).forEach(tab => {
            tab.classList.add('bg-slate-800', 'shadow', 'text-white');
            tab.classList.remove('text-slate-300');
        });

        if (this.state.currentView === 'watchlist') {
            this.renderWatchlist();
        } else if (this.state.currentView === 'scanner') {
            this.renderScanner();
        }
    },
    
    renderHeader() {
        const header = document.getElementById('main-header');
        const sidebarAuthSection = document.getElementById('sidebar-auth-section');
        let content = '';

        let authContent = '';
        if (this.state.user && !this.state.user.isAnonymous) {
            authContent = `
                <div class="flex items-center gap-2">
                    <img src="${this.state.user.photoURL}" alt="User" class="w-8 h-8 rounded-full">
                    <button id="logout-btn" class="text-xs text-slate-400 hover:text-white">登出</button>
                </div>
            `;
        } else {
            authContent = `<button id="login-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg transition-colors text-sm">使用 Google 登入</button>`;
        }

        // Update sidebar auth section for desktop
        if (sidebarAuthSection) {
            sidebarAuthSection.innerHTML = authContent;
        }

        if (this.state.currentView === 'watchlist') {
            content = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="flex bg-slate-700 rounded-lg p-1 h-9">
                            <button data-market="US" class="market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.watchlistMarketView === 'US' ? 'bg-slate-800 shadow' : ''}">美股</button>
                            <button data-market="TW" class="market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.watchlistMarketView === 'TW' ? 'bg-slate-800 shadow' : ''}">台股</button>
                        </div>
                        <button id="add-stock-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold h-9 w-9 flex items-center justify-center rounded-lg transition-colors text-lg">+</button>
                    </div>
                    <div class="lg:hidden">
                        ${authContent}
                    </div>
                </div>
            `;
        } else if (this.state.currentView === 'scanner') {
            content = `
                <div class="flex justify-between items-center">
                    <div class="flex bg-slate-700 rounded-lg p-1">
                        <button data-market="US" class="scanner-market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.scannerMarketView === 'US' ? 'bg-slate-800 shadow' : ''}">美股</button>
                        <button data-market="TW" class="scanner-market-tab px-4 py-1 text-sm font-semibold rounded-md ${this.state.scannerMarketView === 'TW' ? 'bg-slate-800 shadow' : ''}">台股</button>
                    </div>
                    <div class="lg:hidden">
                        ${authContent}
                    </div>
                </div>
            `;
        }
        header.innerHTML = content;

        // Bind auth events for both header and sidebar
        const loginBtns = document.querySelectorAll('#login-btn');
        const logoutBtns = document.querySelectorAll('#logout-btn');
        
        loginBtns.forEach(btn => {
            btn.addEventListener('click', () => this.handleGoogleLogin());
        });
        
        logoutBtns.forEach(btn => {
            btn.addEventListener('click', () => this.handleLogout());
        });

        if (this.state.currentView === 'watchlist') {
            const addBtn = document.getElementById('add-stock-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.toggleModal(true));
            document.querySelectorAll('.market-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.watchlistMarketView = e.currentTarget.dataset.market;
                    this.render();
                });
            });
        } else if (this.state.currentView === 'scanner') {
            document.querySelectorAll('.scanner-market-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.scannerMarketView = e.currentTarget.dataset.market;
                    this.render();
                });
            });
        }
    },

    handleGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        this.state.auth.signInWithPopup(provider).catch(error => {
            console.error("Google 登入失敗:", error);
        });
    },

    handleLogout() {
        this.state.auth.signOut();
    },

    renderWatchlist() {
        document.getElementById('watchlist-last-updated').textContent = `最後更新: ${this.state.lastUpdated.toLocaleTimeString('zh-TW')}`;
        const container = document.getElementById('stock-list-container');
        
        if (this.state.isLoading && this.state.watchlist.length > 0) {
            container.innerHTML = `<div class="loader mx-auto mt-10"></div>`;
            return;
        }

        container.innerHTML = '';
        const filteredList = this.state.watchlist
            .filter(symbol => {
                const market = symbol.endsWith('.TW') ? 'TW' : 'US';
                return market === this.state.watchlistMarketView;
            })
            .sort((a, b) => a.localeCompare(b));

        if (filteredList.length === 0) {
            container.innerHTML = `<p class="text-slate-400 text-center mt-10">此列表是空的，請點擊右上角「+」新增股票。</p>`;
            return;
        }

        // Add responsive grid class for desktop
        container.className = 'space-y-3 md:space-y-0 lg:stock-grid';

        filteredList.forEach(symbol => {
            const stock = this.state.stockDataCache[symbol];
            if (!stock || stock.isLoading) {
                container.innerHTML += `<div class="bg-slate-800 p-4 rounded-xl shadow-sm h-[136px] flex items-center justify-center"><div class="loader"></div></div>`;
                return;
            }
            if (stock.error) {
                 container.innerHTML += `<div class="bg-slate-800 p-4 rounded-xl shadow-sm text-center text-red-500">${symbol}: ${stock.error}</div>`;
                return;
            }

            const indicators = this.calculateIndicators(stock);
            const isUS = stock.market === 'US';
            const isUp = stock.change >= 0;
            const colorClass = isUp ? (isUS ? 'text-green-500' : 'text-red-500') : (isUS ? 'text-red-500' : 'text-green-500');
            
            const card = `
                <div class="bg-slate-800 p-4 rounded-xl shadow-sm cursor-pointer active:bg-slate-700" data-symbol="${symbol}">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-base truncate">${symbol.replace(/\.US$|\.TW$/, '')}</p>
                            <p class="text-xs text-slate-400 truncate">${stock.name}</p>
                        </div>
                        <div class="text-right pl-2">
                            <p class="text-lg font-bold ${colorClass}">${stock.currency}${stock.price.toFixed(2)}</p>
                            <p class="text-sm ${colorClass}">${isUp ? '▲' : '▼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                        </div>
                        <button class="remove-stock-btn text-slate-600 hover:text-red-500 text-2xl ml-3 w-8 h-8 flex items-center justify-center" data-symbol="${symbol}">×</button>
                    </div>
                    <div class="text-xs text-slate-400 mt-3 pt-3 border-t border-slate-700">
                        <div class="flex justify-between">
                            <span>低: <span class="text-red-500">${stock.low.toFixed(2)}</span></span>
                            <span>高: <span class="text-green-500">${stock.high.toFixed(2)}</span></span>
                        </div>
                        <div class="flex justify-between mt-1">
                            <span>3日線: ${indicators.ma3.toFixed(2)}${stock.price < indicators.ma3 ? '<span class="ma-star"> ★</span>' : ''}</span>
                            <span>5日線: ${indicators.ma5.toFixed(2)}${stock.price < indicators.ma5 ? '<span class="ma-star"> ★</span>' : ''}</span>
                            <span>10日線: ${indicators.ma10.toFixed(2)}${stock.price < indicators.ma10 ? '<span class="ma-star"> ★</span>' : ''}</span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });

        document.querySelectorAll('#stock-list-container [data-symbol]').forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-stock-btn')) return;
                this.selectStock(card.dataset.symbol);
            });
        });
        document.querySelectorAll('.remove-stock-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.promptRemoveStock(btn.dataset.symbol);
            });
        });
    },

    renderScanner() {
        document.getElementById('scanner-last-updated').textContent = `最後更新: ${this.state.lastUpdated.toLocaleTimeString('zh-TW')}`;
        const buyContainer = document.getElementById('buy-opportunities');
        const sellContainer = document.getElementById('sell-opportunities');
        
        if (this.state.isLoading) {
            buyContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            sellContainer.innerHTML = '';
            return;
        }

        let buyOpportunities = [];
        let sellOpportunities = [];
        
        const filteredList = this.state.watchlist.filter(symbol => {
            const stockData = this.state.stockDataCache[symbol];
            return stockData && !stockData.error && stockData.market === this.state.scannerMarketView;
        });

        filteredList.forEach(symbol => {
            const stock = this.state.stockDataCache[symbol];
            if (!stock || stock.isLoading || stock.error) return;

            const indicators = this.calculateIndicators(stock);
            const signals = this.getSignals(symbol, stock, indicators);

            if (signals.buy.reasons.length > 0) {
                buyOpportunities.push({ symbol, stock, signalData: signals.buy });
            }
            if (signals.sell.reasons.length > 0) {
                sellOpportunities.push({ symbol, stock, signalData: signals.sell });
            }
        });

        buyOpportunities.sort((a, b) => b.signalData.score - a.signalData.score);
        sellOpportunities.sort((a, b) => b.signalData.score - a.signalData.score);

        // Add responsive grid classes for desktop
        buyContainer.className = 'space-y-3 md:space-y-0 lg:opportunity-grid';
        sellContainer.className = 'space-y-3 md:space-y-0 lg:opportunity-grid';

        buyContainer.innerHTML = buyOpportunities.length > 0 ? buyOpportunities.map(op => this.createOpportunityCard(op.symbol, op.stock, op.signalData)).join('') : `<p class="text-slate-400 text-center p-4">暫無符合條件的買進機會。</p>`;
        sellContainer.innerHTML = sellOpportunities.length > 0 ? sellOpportunities.map(op => this.createOpportunityCard(op.symbol, op.stock, op.signalData)).join('') : `<p class="text-slate-400 text-center p-4">暫無符合條件的賣出機會。</p>`;

        document.querySelectorAll('.opportunity-card').forEach(card => {
            card.addEventListener('click', () => this.selectStock(card.dataset.symbol));
        });
    },

    createOpportunityCard(symbol, stock, signalData) {
        const isUS = stock.market === 'US';
        const isUp = stock.change >= 0;
        const colorClass = isUp ? (isUS ? 'text-green-500' : 'text-red-500') : (isUS ? 'text-red-500' : 'text-green-500');
        
        let strengthHTML = '';
        for (let i = 0; i < 3; i++) {
            const color = i < signalData.score ? 'bg-yellow-400' : 'bg-slate-600';
            strengthHTML += `<span class="strength-dot ${color}"></span>`;
        }
        
        const reasonsHTML = signalData.reasons.map(reason => `<li class="text-xs">${reason}</li>`).join('');

        return `
            <div class="opportunity-card bg-slate-800 p-4 rounded-lg shadow-sm cursor-pointer active:bg-slate-700" data-symbol="${symbol}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-base truncate">${symbol.replace(/\.US$|\.TW$/, '')}</p>
                        <p class="text-xs text-slate-400 truncate">${stock.name}</p>
                    </div>
                    <div class="text-right flex-shrink-0 pl-2">
                        <p class="font-bold text-base ${colorClass}">${stock.currency}${stock.price.toFixed(2)}</p>
                        <p class="text-sm ${colorClass}">${isUp ? '▲' : '▼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                    </div>
                </div>
                <div class="flex justify-between items-end text-sm mt-2 pt-2 border-t border-slate-700">
                    <div class="text-left">
                        <ul class="list-disc list-inside space-y-1 text-slate-300">
                            ${reasonsHTML}
                        </ul>
                    </div>
                    <div class="text-right flex items-center">
                        <span class="font-semibold text-xs mr-2">力度</span>
                        ${strengthHTML}
                    </div>
                </div>
            </div>
        `;
    },

    async renderDetail(symbol) {
        const detailContainer = document.getElementById('detail-content');
        detailContainer.innerHTML = `<div class="loader mx-auto mt-10"></div>`;
        
        const stock = await this.fetchStockData(symbol, true);

        if (stock.error) {
            detailContainer.innerHTML = `<p class="text-red-500 text-center mt-10">${stock.error}</p>`;
            return;
        }
        
        document.getElementById('detail-header-title').textContent = `${symbol.replace(/\.US$|\.TW$/, '')} (${stock.name})`;
        
        detailContainer.innerHTML = `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-3xl font-bold ${stock.change >= 0 ? (stock.market === 'US' ? 'text-green-500' : 'text-red-500') : (stock.market === 'US' ? 'text-red-500' : 'text-green-500')}">${stock.currency}${stock.price.toFixed(2)}</p>
                        <p class="text-base mt-1 ${stock.change >= 0 ? (stock.market === 'US' ? 'text-green-500' : 'text-red-500') : (stock.market === 'US' ? 'text-red-500' : 'text-green-500')}">${stock.change >= 0 ? '▲' : '▼'} ${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)</p>
                    </div>
                    <div class="text-xs text-slate-400 text-right">
                        <p>當日低: <span class="font-semibold">${stock.low.toFixed(2)}</span></p>
                        <p>當日高: <span class="font-semibold">${stock.high.toFixed(2)}</span></p>
                        <p>成交量: <span class="font-semibold">${parseInt(stock.history[0].volume).toLocaleString('en-US')}</span></p>
                        ${stock.pe ? `<p>本益比: <span class="font-semibold">${stock.pe}</span></p>` : ''}
                    </div>
                </div>
            </div>
            <div class="flex bg-slate-700 rounded-lg p-1 mb-4">
                <button data-tab="analysis" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'analysis' ? 'bg-slate-800 shadow' : ''}">分析</button>
                <button data-tab="chart" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'chart' ? 'bg-slate-800 shadow' : ''}">圖表</button>
                <button data-tab="news" class="detail-tab flex-1 px-4 py-2 text-sm font-semibold rounded-md ${this.state.detailViewTab === 'news' ? 'bg-slate-800 shadow' : ''}">新聞</button>
            </div>
            <div id="detail-tab-content"></div>
        `;

        await this.renderDetailTabContent(symbol);

        detailContainer.querySelectorAll('.detail-tab').forEach(tab => {
            tab.addEventListener('click', async (e) => {
                this.state.detailViewTab = e.currentTarget.dataset.tab;
                await this.renderDetail(symbol);
            });
        });
    },

    async renderDetailTabContent(symbol) {
        const tabContainer = document.getElementById('detail-tab-content');
        switch(this.state.detailViewTab) {
            case 'analysis':
                tabContainer.innerHTML = this.getAnalysisContentHTML(symbol);
                document.getElementById('gemini-analysis-btn').addEventListener('click', () => this.handleGeminiAnalysis(symbol));
                break;
            case 'chart':
                tabContainer.innerHTML = this.getChartContentHTML(symbol);
                await this.renderAdvancedChart(symbol);
                document.querySelectorAll('.chart-timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        this.state.chartTimeframe = e.currentTarget.dataset.timeframe;
                        await this.renderDetailTabContent(symbol);
                    });
                });
                break;
            case 'news':
                this.renderNews(symbol);
                break;
        }
    },

    getAnalysisContentHTML(symbol) {
        const stock = this.state.stockDataCache[symbol];
        const indicators = this.calculateIndicators(stock);
        const macdColor = indicators.macd.histogram >= 0 ? 'text-green-500' : 'text-red-500';
        const macdDirection = indicators.macd.histogram >= 0 ? '多頭' : '空頭';

        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-bold mb-3">近七日價格區間</h3>
                <div class="space-y-3">${this.render7DayPriceVisual(symbol)}</div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <h3 class="text-lg font-bold mb-3">技術指標參考</h3>
                <div class="grid grid-cols-2 gap-3">
                    ${this.createAnalysisCard('RSI (14日)', `<span class="font-bold text-xl ${indicators.rsi > 70 ? 'text-red-500' : (indicators.rsi < 30 ? 'text-green-500' : '')}">${indicators.rsi.toFixed(2)}</span>`)}
                    ${this.createAnalysisCard('MACD (12,26,9)', `<span class="font-bold text-xl ${macdColor}">${indicators.macd.histogram.toFixed(2)}</span><br><span class="text-xs ${macdColor}">${macdDirection}動能</span>`)}
                    ${this.createAnalysisCard('布林通道', `上軌: ${indicators.bb.upper.toFixed(2)}<br>下軌: ${indicators.bb.lower.toFixed(2)}`)}
                    ${this.createAnalysisCard('量價關係', `5日均量比: <span class="font-bold text-xl">${(stock.history[0].volume / indicators.avgVol5).toFixed(2)}</span>`)}
                </div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                 <h3 class="text-lg font-bold mb-3">Gemini AI 智慧解讀</h3>
                 <button id="gemini-analysis-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full" ${this.state.isGeminiLoading ? 'disabled' : ''}>
                    ${this.state.isGeminiLoading ? '分析中...' : '生成技術面分析 ✨'}
                 </button>
                 <div id="gemini-analysis-result" class="mt-4 p-3 bg-slate-700 rounded-lg text-slate-300 min-h-[100px] text-sm break-words">
                    點擊按鈕，讓 AI 為您解讀目前的技術指標。
                 </div>
            </div>
        `;
    },

    getChartContentHTML() {
        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">K 線圖</h3>
                    <div class="flex bg-slate-700 rounded-lg p-1">
                        <button data-timeframe="5M" class="chart-timeframe-btn px-2 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === '5M' ? 'bg-slate-800 shadow' : ''}">5分線</button>
                        <button data-timeframe="D" class="chart-timeframe-btn px-3 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === 'D' ? 'bg-slate-800 shadow' : ''}">日線</button>
                        <button data-timeframe="W" class="chart-timeframe-btn px-3 py-1 text-xs font-semibold rounded-md ${this.state.chartTimeframe === 'W' ? 'bg-slate-800 shadow' : ''}">週線</button>
                    </div>
                </div>
                <div class="advanced-chart-container">
                    <canvas id="advanced-chart"></canvas>
                </div>
            </div>
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">MACD 指標</h3>
                </div>
                <div class="advanced-chart-container" style="height: 300px;">
                    <canvas id="macd-chart"></canvas>
                </div>
            </div>
        `;
    },

    async renderNews(symbol) {
        const tabContainer = document.getElementById('detail-tab-content');
        tabContainer.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl shadow-md"><div class="loader mx-auto"></div></div>`;

        try {
            const response = await fetch(`/api/get-stock-data?action=get_news&symbol=${symbol}`);
            const newsData = await response.json();

            if (!response.ok) {
                throw new Error(newsData.error || '獲取新聞失敗');
            }

            tabContainer.innerHTML = this.getNewsContentHTML(symbol, newsData);
        } catch (error) {
            tabContainer.innerHTML = `<div class="bg-slate-800 p-4 rounded-xl shadow-md"><p class="text-red-500 text-center">${error.message}</p></div>`;
        }
    },

    getNewsContentHTML(symbol, newsItems) {
        let newsListHTML = '';
        if (newsItems && newsItems.length > 0) {
            newsListHTML = newsItems.map(item => {
                const date = new Date(item.datetime * 1000);
                const timeAgo = this.formatTimeAgo(date);
                return `
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block border-b border-slate-700 pb-3 last:border-b-0 hover:bg-slate-700 -mx-4 px-4 py-2 rounded-lg">
                        <h4 class="font-semibold text-base line-clamp-2">${item.headline}</h4>
                        <div class="text-xs text-slate-400 mt-1 flex justify-between">
                            <span>${item.source}</span>
                            <span>${timeAgo}</span>
                        </div>
                    </a>
                `;
            }).join('');
        } else {
            newsListHTML = `<p class="text-slate-400 text-center">找不到相關新聞。</p>`;
        }
        
        return `
            <div class="bg-slate-800 p-4 rounded-xl shadow-md">
                <h3 class="text-lg font-bold mb-3">市場新聞與資訊</h3>
                <div class="space-y-2">
                    ${newsListHTML}
                </div>
            </div>
        `;
    },

    formatTimeAgo(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " 年前";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " 個月前";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " 天前";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " 小時前";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " 分鐘前";
        return "剛剛";
    },
    
    render7DayPriceVisual(symbol) {
        const history = this.state.stockDataCache[symbol].history;
        if (!history || history.length === 0) return '';
        const last7Days = history.slice(0, 7);
        const allLows = last7Days.map(d => d.low);
        const allHighs = last7Days.map(d => d.high);
        const minPrice = Math.min(...allLows);
        const maxPrice = Math.max(...allHighs);
        const totalRange = maxPrice - minPrice;

        if (totalRange === 0) return '<p>價格無波動</p>';

        let html = '';
        last7Days.forEach(day => {
            const dayRange = day.high - day.low;
            const barWidth = (dayRange / totalRange) * 100;
            const barLeft = ((day.low - minPrice) / totalRange) * 100;
            const tickLeft = dayRange > 0 ? ((day.close - day.low) / dayRange) * 100 : 50;
            
            html += `
                <div class="flex items-center text-sm">
                    <span class="w-12 text-slate-400">${day.date.substring(5)}</span>
                    <div class="flex-1 price-range-bar-bg bg-slate-700 mx-2">
                        <div class="price-range-bar-fg bg-sky-800" style="width: ${barWidth}%; left: ${barLeft}%;">
                            <div class="price-range-bar-tick bg-sky-400" style="left: ${tickLeft}%;"></div>
                        </div>
                    </div>
                    <span class="w-28 text-right font-semibold text-slate-300">$${day.low.toFixed(2)}~${day.high.toFixed(2)}</span>
                </div>
            `;
        });
        return html;
    },

    calculateWeeklyData(dailyHistory, maxWeeks = null) {
        if (!dailyHistory || dailyHistory.length < 1) return [];

        // 確保有足夠的日線數據來生成週線
        console.log('Daily history length for weekly calculation:', dailyHistory.length);

        const weeklyMap = new Map();
        // 不要在這裡 reverse，保持原有順序處理
        dailyHistory.forEach(day => {
            const date = new Date(day.date);
            const weekStartDate = new Date(date);
            weekStartDate.setDate(date.getDate() - date.getDay());
            const weekKey = weekStartDate.toISOString().split('T')[0];

            if (!weeklyMap.has(weekKey)) {
                weeklyMap.set(weekKey, {
                    open: day.open,
                    high: day.high,
                    low: day.low,
                    close: day.close,
                    volume: day.volume,
                    date: weekKey
                });
            } else {
                const week = weeklyMap.get(weekKey);
                week.high = Math.max(week.high, day.high);
                week.low = Math.min(week.low, day.low);
                week.close = day.close; // 最後一天的收盤價
                week.volume += day.volume;
            }
        });

        // 轉換為數組並按日期排序（最新的在前面）
        const weeklyData = Array.from(weeklyMap.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
        
        console.log('Generated weekly data length:', weeklyData.length);
        
        // 如果指定了最大週數，則限制返回的數據
        if (maxWeeks && weeklyData.length > maxWeeks) {
            return weeklyData.slice(0, maxWeeks);
        }
        
        return weeklyData;
    },

    async renderAdvancedChart(symbol) {
        console.log('開始渲染圖表，symbol:', symbol, 'timeframe:', this.state.chartTimeframe);
        
        // 清理現有圖表
        if (this.state.advancedChartInstance) {
            this.state.advancedChartInstance.destroy();
            this.state.advancedChartInstance = null;
        }
        if (this.state.macdChartInstance) {
            this.state.macdChartInstance.destroy();
            this.state.macdChartInstance = null;
        }
        
        // 檢查 Canvas 元素是否存在
        const chartCanvas = document.getElementById('advanced-chart');
        const macdCanvas = document.getElementById('macd-chart');
        
        if (!chartCanvas || !macdCanvas) {
            console.error('Chart canvas elements not found:', {
                chartCanvas: !!chartCanvas,
                macdCanvas: !!macdCanvas
            });
            return;
        }
        
        // 根據時間框架獲取相應的數據
        let stockData;
        if (this.state.chartTimeframe === '5M') {
            stockData = await this.fetchStockData(symbol, true, '5M');
        } else {
            stockData = this.state.stockDataCache[symbol];
        }
        
        if (!stockData || stockData.error) {
            console.error('無法獲取股票數據:', stockData?.error || '數據不存在');
            const ctx = chartCanvas.getContext('2d');
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('數據載入失敗', chartCanvas.width / 2, chartCanvas.height / 2);
            return;
        }
        
        const history = stockData.history;
        let chartData;
        let macdData; // 用於 MACD 計算的更多數據
        let timeUnit;

        if (this.state.chartTimeframe === 'W') {
            // 週線需要更多的日線數據來生成足夠的週線數據
            // 使用最多245天（約35週 x 7天）的數據來確保能生成35週的週線數據
            const dailyDataForWeekly = history.slice(0, Math.min(245, history.length));
            console.log('Daily data for weekly conversion:', dailyDataForWeekly.length);
            
            chartData = this.calculateWeeklyData(dailyDataForWeekly, 35); // 調整到35週顯示週線數據
            macdData = chartData; // 週線使用生成的週線數據
            timeUnit = 'week';
            
            console.log('Final weekly chart data length:', chartData.length);
        } else if (this.state.chartTimeframe === '5M') {
            // 5分線圖顯示當天所有數據
            chartData = history.reverse(); // 5分線數據已經是正確順序
            macdData = chartData; // 5分線MACD使用相同數據
            timeUnit = 'minute';
            
            console.log('Final 5min chart data length:', chartData.length);
        } else {
            // K線圖顯示最近30天，但MACD計算使用更多數據
            chartData = history.slice(0, 30).reverse();
            // MACD 計算使用最多60天的數據以確保準確性
            macdData = history.slice(0, Math.min(60, history.length)).reverse();
            timeUnit = 'day';
        }

        // 驗證圖表數據
        if (!chartData || chartData.length === 0) {
            console.error('Chart data is empty or invalid');
            return;
        }
        
        console.log('Chart data prepared:', {
            length: chartData.length,
            timeframe: this.state.chartTimeframe,
            sampleData: chartData.slice(0, 3)
        });

        // 繪製 K 線圖
        const ctx = chartCanvas.getContext('2d');
        
        const data = chartData.map(d => {
            const timestamp = new Date(d.date).getTime();
            if (isNaN(timestamp)) {
                console.warn('Invalid date found:', d.date);
                return null;
            }
            return {
                x: timestamp,
                o: parseFloat(d.open) || 0,
                h: parseFloat(d.high) || 0,
                l: parseFloat(d.low) || 0,
                c: parseFloat(d.close) || 0
            };
        }).filter(d => d !== null);
        
        console.log('Processed K-line data:', {
            length: data.length,
            sample: data.slice(0, 2)
        });

        try {
            console.log('Creating K-line chart...');
            this.state.advancedChartInstance = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: `${symbol} K-Line`,
                    data: data,
                    borderColor: '#94a3b8',
                    color: {
                        up: '#22c55e',
                        down: '#ef4444',
                        unchanged: '#94a3b8'
                    },
                    borderWidth: 1
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { 
                            unit: timeUnit,
                            displayFormats: {
                                minute: 'HH:mm',
                                day: 'MM/dd', 
                                week: 'MM/dd'
                            }
                        },
                        grid: { 
                            color: 'rgba(71, 85, 105, 0.3)',
                            display: true
                        },
                        ticks: { 
                            color: '#94a3b8',
                            maxTicksLimit: 8
                        }
                    },
                    y: { 
                        grid: { 
                            color: 'rgba(71, 85, 105, 0.3)',
                            display: true
                        },
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    legend: { 
                        display: false 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: '#475569',
                        borderWidth: 1,
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].parsed.x);
                                return date.toLocaleDateString('zh-TW');
                            },
                            label: function(context) {
                                const d = context.raw;
                                return [
                                    `開盤: $${d.o?.toFixed(2) || 'N/A'}`,
                                    `最高: $${d.h?.toFixed(2) || 'N/A'}`,
                                    `最低: $${d.l?.toFixed(2) || 'N/A'}`,
                                    `收盤: $${d.c?.toFixed(2) || 'N/A'}`
                                ];
                            }
                        }
                    }
                }
            });
            
            console.log('K-line chart created successfully');
            
            // 繪製 MACD 圖表，使用更多的歷史數據進行計算
            this.renderMACDChart(symbol, macdData, timeUnit);
            
        } catch (error) {
            console.error('Error creating K-line chart:', error);
            
            // 顯示錯誤信息
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.fillStyle = '#ef4444';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('K線圖創建失敗: ' + error.message, chartCanvas.width / 2, chartCanvas.height / 2);
        }
    },

    renderMACDChart(symbol, macdData, timeUnit) {
        const macdCtx = document.getElementById('macd-chart');
        if (!macdCtx) {
            console.error('MACD chart canvas element not found');
            return;
        }
        
        const ctx = macdCtx.getContext('2d');
        const macdCalculation = this.calculateMACDHistory(macdData);
        
        // 檢查數據是否有效
        console.log('MACD Calculation Data:', macdCalculation);
        console.log('MACD Source Data Length:', macdData.length);
        console.log('Histogram values:', macdCalculation.histogram.slice(-10)); // 顯示最後 10 個值
        
        // 只顯示最近 30 天的 MACD 數據（與 K 線圖對應）
        const displayLength = timeUnit === 'week' ? macdData.length : Math.min(30, macdData.length);
        const displayData = {
            histogram: macdCalculation.histogram.slice(-displayLength),
            macdLine: macdCalculation.macdLine.slice(-displayLength),
            signalLine: macdCalculation.signalLine.slice(-displayLength)
        };
        
        const labels = macdData.slice(-displayLength).map(d => new Date(d.date).getTime());
        
        // 確保數據有效
        const nonZeroCount = displayData.histogram.filter(val => val !== 0).length;
        if (nonZeroCount === 0) {
            console.warn('All MACD histogram values are zero, showing placeholder chart');
            // 顯示空圖表但保留結構
            ctx.clearRect(0, 0, macdCtx.width, macdCtx.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('數據不足，無法計算 MACD', macdCtx.width / 2, macdCtx.height / 2);
            return;
        }

        console.log(`Found ${nonZeroCount} non-zero MACD values out of ${displayData.histogram.length} display points`);

        // 準備時間軸數據
        const timeAxisData = labels.map((timestamp, index) => ({
            x: timestamp,
            y: displayData.histogram[index] || 0
        }));
        
        const difLineData = labels.map((timestamp, index) => ({
            x: timestamp,
            y: displayData.macdLine[index] || 0
        }));
        
        const deaLineData = labels.map((timestamp, index) => ({
            x: timestamp,
            y: displayData.signalLine[index] || 0
        }));

        try {
            console.log('Creating MACD chart...');
            this.state.macdChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: 'MACD 柱狀圖',
                            data: timeAxisData,
                            backgroundColor: displayData.histogram.map(value => 
                                value >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                            ),
                            borderColor: displayData.histogram.map(value => 
                                value >= 0 ? '#16a34a' : '#dc2626'
                            ),
                            borderWidth: 1,
                            borderSkipped: false,
                            barThickness: 'flex',
                            maxBarThickness: 8,
                            order: 3
                        },
                        {
                            label: 'DIF',
                            data: difLineData,
                            type: 'line',
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            order: 1
                        },
                        {
                            label: 'DEA',
                            data: deaLineData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            order: 2
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                        type: 'time',
                        time: { 
                            unit: timeUnit,
                            displayFormats: {
                                minute: 'HH:mm',
                                day: 'MM/dd',
                                week: 'MM/dd'
                            }
                        },
                        grid: { 
                            color: 'rgba(71, 85, 105, 0.3)',
                            display: true
                        },
                        ticks: { 
                            color: '#94a3b8',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        grid: { 
                            color: 'rgba(71, 85, 105, 0.3)',
                            display: true
                        },
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) {
                                return value.toFixed(4);
                            }
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#94a3b8',
                            font: { size: 10 },
                            usePointStyle: true,
                            pointStyle: 'line',
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: '#475569',
                        borderWidth: 1,
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].parsed.x);
                                return date.toLocaleDateString('zh-TW');
                            },
                            label: function(context) {
                                const datasetLabel = context.dataset.label;
                                const value = context.parsed.y;
                                
                                if (datasetLabel === 'MACD 柱狀圖') {
                                    const trend = value >= 0 ? '多頭' : '空頭';
                                    return `${datasetLabel}: ${value.toFixed(4)} (${trend})`;
                                } else {
                                    return `${datasetLabel}: ${value.toFixed(4)}`;
                                }
                            },
                            afterLabel: function(context) {
                                if (context.datasetIndex === 0) {
                                    const histogram = context.parsed.y;
                                    return `趨勢強度: ${Math.abs(histogram).toFixed(4)}`;
                                }
                                return null;
                            }
                        }
                    }
                }
            });
            
            console.log('MACD chart created successfully');
            
        } catch (error) {
            console.error('Error creating MACD chart:', error);
            
            // 顯示錯誤信息
            ctx.clearRect(0, 0, macdCtx.width, macdCtx.height);
            ctx.fillStyle = '#ef4444';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('MACD圖創建失敗: ' + error.message, macdCtx.width / 2, macdCtx.height / 2);
        }
    },

    calculateMACDHistory(chartData) {
        const closes = chartData.map(d => d.close);
        
        console.log('MACD calculation input:', {
            chartDataLength: chartData.length,
            closesLength: closes.length,
            sampleCloses: closes.slice(0, 5),
            sampleDates: chartData.slice(0, 5).map(d => d.date)
        });
        
        if (closes.length < 35) {
            console.warn('Not enough data for MACD calculation, need at least 35 data points, got:', closes.length);
            return {
                macdLine: new Array(chartData.length).fill(0),
                signalLine: new Array(chartData.length).fill(0),
                histogram: new Array(chartData.length).fill(0)
            };
        }
        
        // 確保數據是按時間順序排列（最舊的在前面）
        // 檢查數據順序，如果是新到舊則需要反轉
        const isNewestFirst = new Date(chartData[0].date) > new Date(chartData[chartData.length - 1].date);
        let orderedData = chartData;
        if (isNewestFirst) {
            orderedData = [...chartData].reverse();
            console.log('Reversed data order for MACD calculation');
        }
        
        const orderedCloses = orderedData.map(d => d.close);
        
        console.log('Ordered closes for MACD:', {
            length: orderedCloses.length,
            first5: orderedCloses.slice(0, 5),
            last5: orderedCloses.slice(-5),
            dates: { 
                first: orderedData[0].date, 
                last: orderedData[orderedData.length - 1].date 
            }
        });
        
        // EMA 計算函數
        const calculateEMA = (data, period) => {
            const multiplier = 2 / (period + 1);
            let ema = new Array(data.length);
            
            // 第一個 EMA 值使用 SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i];
            }
            ema[period - 1] = sum / period;
            
            // 計算後續 EMA 值
            for (let i = period; i < data.length; i++) {
                ema[i] = (data[i] - ema[i - 1]) * multiplier + ema[i - 1];
            }
            
            return ema;
        };
        
        // 計算 12日和26日 EMA
        const ema12 = calculateEMA(orderedCloses, 12);
        const ema26 = calculateEMA(orderedCloses, 26);
        
        // 計算 MACD 線
        const macdLine = new Array(orderedCloses.length).fill(0);
        for (let i = 25; i < orderedCloses.length; i++) { // 從第26個數據點開始
            if (ema12[i] !== undefined && ema26[i] !== undefined) {
                macdLine[i] = ema12[i] - ema26[i];
            }
        }
        
        // 獲取有效的 MACD 值來計算 Signal 線
        const validMacdValues = [];
        for (let i = 25; i < orderedCloses.length; i++) {
            if (macdLine[i] !== 0) {
                validMacdValues.push(macdLine[i]);
            }
        }
        
        // 計算 Signal 線（MACD 的9日EMA）
        const signalLine = new Array(orderedCloses.length).fill(0);
        if (validMacdValues.length >= 9) {
            const signalEMA = calculateEMA(validMacdValues, 9);
            let signalIndex = 0;
            for (let i = 25; i < orderedCloses.length; i++) {
                if (macdLine[i] !== 0) {
                    if (signalIndex >= 8 && signalEMA[signalIndex] !== undefined) {
                        signalLine[i] = signalEMA[signalIndex];
                    }
                    signalIndex++;
                }
            }
        }
        
        // 計算 Histogram
        const histogram = new Array(orderedCloses.length).fill(0);
        for (let i = 0; i < orderedCloses.length; i++) {
            if (macdLine[i] !== 0 && signalLine[i] !== 0) {
                histogram[i] = macdLine[i] - signalLine[i];
            } else if (macdLine[i] !== 0) {
                // 如果沒有 Signal 線，至少顯示 MACD 線的值
                histogram[i] = macdLine[i];
            }
        }
        
        console.log('MACD calculation details:', {
            dataLength: orderedData.length,
            validMacdValues: validMacdValues.length,
            nonZeroHistogram: histogram.filter(val => val !== 0).length,
            sampleHistogram: histogram.slice(-10),
            sampleMacd: macdLine.slice(-10),
            sampleSignal: signalLine.slice(-10)
        });
        
        // 如果原始數據是新到舊的順序，需要將結果也反轉回去
        let resultMacd = macdLine;
        let resultSignal = signalLine;
        let resultHistogram = histogram;
        
        if (isNewestFirst) {
            resultMacd = [...macdLine].reverse();
            resultSignal = [...signalLine].reverse();
            resultHistogram = [...histogram].reverse();
            console.log('Reversed results back to original order');
        }
        
        return {
            macdLine: resultMacd,
            signalLine: resultSignal,
            histogram: resultHistogram
        };
    },

    createAnalysisCard(title, content) {
        return `
            <div class="bg-slate-700 p-3 rounded-lg text-center">
                <h4 class="font-semibold text-slate-300 text-xs mb-1">${title}</h4>
                <div class="text-slate-400 text-sm leading-relaxed">${content}</div>
            </div>
        `;
    },

    selectStock(symbol) {
        this.state.previousView = this.state.currentView;
        this.state.selectedStock = symbol;
        this.state.detailViewTab = 'analysis';
        this.state.chartTimeframe = 'D'; // Reset to daily view
        this.renderDetail(symbol);
        const detailView = document.getElementById('view-detail');
        detailView.classList.remove('hidden');
        requestAnimationFrame(() => {
            detailView.classList.remove('translate-x-full');
        });
    },

    closeDetailView() {
        const detailView = document.getElementById('view-detail');
        detailView.classList.add('translate-x-full');
        setTimeout(() => {
            detailView.classList.add('hidden');
            this.state.selectedStock = null;
            if (this.state.advancedChartInstance) {
                this.state.advancedChartInstance.destroy();
                this.state.advancedChartInstance = null;
            }
            if (this.state.macdChartInstance) {
                this.state.macdChartInstance.destroy();
                this.state.macdChartInstance = null;
            }
            this.navigate(this.state.previousView);
        }, 300);
    },
    
    toggleModal(show) {
        const modal = document.getElementById('add-stock-modal');
        const feedbackEl = document.getElementById('add-stock-feedback');
        const inputEl = document.getElementById('add-stock-input');
        const promptEl = document.getElementById('add-stock-prompt');
        feedbackEl.textContent = '';
        inputEl.value = '';

        if (show) {
            const market = this.state.watchlistMarketView === 'TW' ? '台股' : '美股';
            const example = this.state.watchlistMarketView === 'TW' ? '2330' : 'AAPL';
            promptEl.textContent = `請輸入${market}代號 (例如: ${example})`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            inputEl.focus();
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    },

    async addStockFromInput() {
        const inputEl = document.getElementById('add-stock-input');
        const feedbackEl = document.getElementById('add-stock-feedback');
        const addButton = document.getElementById('modal-add-btn');
        let symbol = inputEl.value.trim().toUpperCase();

        if (!symbol) {
            feedbackEl.textContent = '請輸入股票代號。';
            return;
        }

        if (!symbol.includes('.')) {
            const suffix = this.state.watchlistMarketView === 'TW' ? '.TW' : '.US';
            symbol += suffix;
        }

        // 拒絕台股請求
        if (symbol.includes('.TW')) {
            feedbackEl.textContent = '目前暫不支援台股，請輸入美股代號';
            return;
        }

        if (this.state.watchlist.includes(symbol)) {
            feedbackEl.textContent = '此股票已在自選清單中。';
            return;
        }
        
        addButton.disabled = true;
        addButton.textContent = '新增中...';
        feedbackEl.textContent = '';

        const stockData = await this.fetchStockData(symbol, true);
        
        if (stockData.error) {
            feedbackEl.textContent = `新增失敗: ${stockData.error}`;
            addButton.disabled = false;
            addButton.textContent = '新增';
        } else {
            const newWatchlist = [symbol, ...this.state.watchlist];
            if (this.state.userId) { // Firebase mode
                this.state.db.collection('users').doc(this.state.userId).set({ watchlist: newWatchlist })
                    .then(() => this.toggleModal(false))
                    .catch(error => feedbackEl.textContent = `新增失敗: ${error.message}`);
            } else { // LocalStorage mode
                this.state.watchlist = newWatchlist;
                this.saveWatchlistToLocalStorage();
                this.render();
                this.toggleModal(false);
            }
            addButton.disabled = false;
            addButton.textContent = '新增';
        }
    },

    promptRemoveStock(symbol) {
        this.state.stockToRemove = symbol;
        const stockName = this.state.stockDataCache[symbol]?.name || symbol;
        document.getElementById('remove-stock-prompt').innerHTML = `確定要從自選清單中移除 <strong class="text-sky-400">${stockName}</strong> 嗎？`;
        this.toggleRemoveModal(true);
    },

    toggleRemoveModal(show) {
        const modal = document.getElementById('confirm-remove-modal');
        if (show) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            this.state.stockToRemove = null;
        }
    },
    
    confirmRemoveStock() {
        const symbol = this.state.stockToRemove;
        if (!symbol) return;

        const newWatchlist = this.state.watchlist.filter(s => s !== symbol);
        if (this.state.userId) { // Firebase mode
            this.state.db.collection('users').doc(this.state.userId).set({ watchlist: newWatchlist })
                .catch(error => console.error("移除股票失敗:", error));
        } else { // LocalStorage mode
            this.state.watchlist = newWatchlist;
            this.saveWatchlistToLocalStorage();
            this.render();
        }
        this.toggleRemoveModal(false);
    },

    calculateIndicators(stockData) {
        const history = stockData.history;
        if (!history || history.length < 10) return { ma3: stockData.price || 0, ma5: stockData.price || 0, ma10: stockData.price || 0, ma20: stockData.price || 0, ma30: stockData.price || 0, rsi: 50, bb: { upper: 0, middle: 0, lower: 0 }, macd: { macd: 0, signal: 0, histogram: 0 }, high30: 0, low30: 0, avgVol5: 0 };
        const closes = history.map(d => d.close).reverse(); // Oldest to newest
        const volumes = history.map(d => d.volume).reverse();
        
        const sum = (arr) => arr.reduce((a, b) => a + b, 0);
        const avg = (arr) => sum(arr) / arr.length;
        const ma = (period) => closes.length >= period ? avg(closes.slice(-period)) : (closes.length > 0 ? avg(closes) : stockData.price || 0);
        
        const high30 = history.length >= 30 ? Math.max(...history.slice(0, 30).map(d => d.high)) : (history.length > 0 ? Math.max(...history.map(d => d.high)) : stockData.high || stockData.price || 0);
        const low30 = history.length >= 30 ? Math.min(...history.slice(0, 30).map(d => d.low)) : (history.length > 0 ? Math.min(...history.map(d => d.low)) : stockData.low || stockData.price || 0);
        const avgVol5 = volumes.length >= 5 ? avg(volumes.slice(-5)) : (volumes.length > 0 ? avg(volumes) : 0);

        let gains = 0, losses = 0;
        const rsiPeriod = Math.min(14, closes.length - 1);
        if (rsiPeriod > 0) {
            for (let i = closes.length - rsiPeriod; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                if (diff > 0) gains += diff; else losses -= diff;
            }
        }
        const rs = (rsiPeriod > 0 && losses > 0) ? (gains / rsiPeriod) / (losses / rsiPeriod) : 1;
        const rsi = isFinite(rs) ? 100 - (100 / (1 + rs)) : 50;

        const ma20 = ma(20);
        const bbPeriod = Math.min(20, closes.length);
        const bbCloses = closes.slice(-bbPeriod);
        const stdDev = bbCloses.length > 1 ? Math.sqrt(avg(bbCloses.map(p => Math.pow(p - ma20, 2)))) : 0;
        const bb = { upper: ma20 + (stdDev * 2), middle: ma20, lower: ma20 - (stdDev * 2) };

        // MACD Calculation
        const ema = (data, period) => {
            const multiplier = 2 / (period + 1);
            let emaArray = [avg(data.slice(0, period))];
            for (let i = period; i < data.length; i++) {
                const newEma = (data[i] - emaArray[emaArray.length - 1]) * multiplier + emaArray[emaArray.length - 1];
                emaArray.push(newEma);
            }
            return emaArray;
        };
        const ema12 = ema(closes, 12);
        const ema26 = ema(closes, 26);
        const macdLine = ema12.slice(-ema26.length).map((val, idx) => val - ema26[idx]);
        const signalLine = ema(macdLine, 9);
        const macd = {
            macd: macdLine[macdLine.length - 1],
            signal: signalLine[signalLine.length - 1],
            histogram: macdLine[macdLine.length - 1] - signalLine[signalLine.length - 1],
            prevMacd: macdLine[macdLine.length - 2],
            prevSignal: signalLine[signalLine.length - 2],
        };

        return { ma3: ma(3), ma5: ma(5), ma10: ma(10), ma20, ma30: ma(30), rsi, bb, macd, high30, low30, avgVol5 };
    },

    getSignals(symbol, stock, indicators) {
        const buyReasons = [], sellReasons = [];
        if (indicators.rsi < 35) buyReasons.push('RSI 接近超賣區');
        if (stock.price <= indicators.bb.lower * 1.01) buyReasons.push('股價接近布林通道下軌');
        if (stock.price <= indicators.ma10 && stock.price >= indicators.ma10 * 0.98) buyReasons.push('股價回測10日線');
        if (stock.history[0].volume > indicators.avgVol5 * 1.5 && stock.change > 0) buyReasons.push('價漲量增');
        if (indicators.macd.prevMacd < indicators.macd.prevSignal && indicators.macd.macd > indicators.macd.signal) buyReasons.push('MACD 黃金交叉');

        if (indicators.rsi > 65) sellReasons.push('RSI 接近超買區');
        if (stock.price >= indicators.bb.upper * 0.99) sellReasons.push('股價接近布林通道上軌');
        if (stock.price / indicators.ma5 > 1.08) sellReasons.push('股價與5日線乖離過大');
        if (stock.history[0].volume > indicators.avgVol5 * 1.5 && stock.change < 0) sellReasons.push('價跌量增');
        if (indicators.macd.prevMacd > indicators.macd.prevSignal && indicators.macd.macd < indicators.macd.signal) sellReasons.push('MACD 死亡交叉');

        return {
            buy: { reasons: buyReasons, score: Math.min(buyReasons.length, 3) },
            sell: { reasons: sellReasons, score: Math.min(sellReasons.length, 3) }
        };
    },
    
    async handleGeminiAnalysis(symbol) {
        if (this.state.isGeminiLoading) return;
        this.state.isGeminiLoading = true;
        const resultContainer = document.getElementById('gemini-analysis-result');
        const analysisBtn = document.getElementById('gemini-analysis-btn');
        analysisBtn.disabled = true;
        analysisBtn.innerHTML = '分析中...';
        resultContainer.innerHTML = '<div class="loader"></div>';
        
        const stock = this.state.stockDataCache[symbol];
        const indicators = this.calculateIndicators(stock);
        
        try {
            const response = await fetch('/api/get-stock-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock, indicators })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `API 請求失敗: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.analysis) {
                resultContainer.innerHTML = this.formatGeminiResponse(result.analysis);
            } else {
                throw new Error('從 API 收到的回應格式不正確。');
            }

        } catch (error) {
            resultContainer.innerHTML = `<p class="text-red-500">分析時發生錯誤：${error.message}</p>`;
        } finally {
            this.state.isGeminiLoading = false;
            analysisBtn.disabled = false;
            analysisBtn.innerHTML = '重新生成分析 ✨';
        }
    },

    formatGeminiResponse(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-100 block mb-2">$1</strong>');
        
        const listItemsRegex = /(\* .+(\n|$))+/g;
        html = html.replace(listItemsRegex, (match) => {
            const items = match.trim().split('\n');
            const listHtml = items.map(item => `<li class="mb-1">${item.substring(2).trim()}</li>`).join('');
            return `<ul class="list-disc list-inside space-y-1">${listHtml}</ul>`;
        });
        
        return html;
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());

// 註冊 Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(registration => {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

</body>
</html>
